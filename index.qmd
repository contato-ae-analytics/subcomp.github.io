---
title: "Relatório Analítico Subgerência de Compras | SUBCOMP"
subtitle: "Fundação Hospitalar Alfredo da Matta (FUHAM)"
author: "Alexssandro Silva | ΛΣ Consultoria"
# date: "`r format(Sys.Date(), '%d de %B de 2025')`"
# Tags para ajudar no filtro da página principal
# description: "Análise Exploratória e Modelagem Preditiva de Dados de Compras"
# categories: ["Análise Exploratória de Dados"]
date: last-modified
# Configuração de Idioma e tradução
# lang: pt
# format: 
#   html: 
#     theme: flatly # IMPORTANTE: Remove o tema padrão para usar 100% o nosso CSS
#     # Configurações de Layout
#     toc: true # Table of Contents (Menu da Direita)
#     toc-title: "Nesta página"
#     fontsize: 0.9em
#     margin-left: 0em
#     margin-right: 0em
#     margin-bottom: 0em
#     margin-top: -1em
#     number-sections: true
#     code-fold: true
page-layout: full
title-block-banner: true
---

<!-- <br> -->

::: {style="border-top: 2px solid #003366;"}
:::

<br>

```{r setup, include=FALSE}
# Define opções padrão para todos os chunks de código no R Markdown
knitr::opts_chunk$set(
  # echo = FALSE: Oculta o código R no documento final, mas mostra os resultados (gráficos/tabelas).
  # Se fosse TRUE, o código apareceria escrito no PDF.
  echo = FALSE,        

  # warning = FALSE: Evita que avisos do R (aquelas mensagens em laranja/vermelho) apareçam no relatório.
  warning = FALSE,     

  # message = FALSE: Evita que mensagens informativas de carregamento de pacotes apareçam no relatório.
  message = FALSE,     

  # fig.width = 10: Define que todos os gráficos gerados terão 10 polegadas de largura por padrão.
  fig.width = 10,      

  # fig.height = 6: Define que todos os gráficos gerados terão 6 polegadas de altura por padrão.
  fig.height = 6,      

  # fig.align = 'center': Garante que todos os gráficos fiquem centralizados horizontalmente na página.
  fig.align = 'center',

  # include = TRUE: Garante que o conteúdo (resultados) seja incluído no documento. 
  # Se fosse FALSE, o código rodaria "escondido" e nada apareceria (nem código, nem resultado).
  include = TRUE       
)

```


::: {style="text-align: justify"}

```{r}
#| label: setup-plots
#| code-summary: "Algoritimos auxiliares"

# ------------------------------------------------------------------------------
# A. Importação de Dados
# ------------------------------------------------------------------------------

if(!require("gsheet")) install.packages("gsheet", quiet = TRUE) ; library("gsheet")     
if(!require("readxl")) install.packages("readxl", quiet = TRUE) ; library("readxl")
if(!require("readr")) install.packages("readr", quiet = TRUE) ; library("readr")

# ------------------------------------------------------------------------------
# B. Manipulação e Visualização de Dados
# ------------------------------------------------------------------------------

if(!require("tidyverse")) install.packages("tidyverse", quiet = TRUE) ; library("tidyverse")  
if(!require("janitor")) install.packages("janitor", quiet = TRUE) ; library("janitor")
if(!require("lubridate")) install.packages("lubridate", quiet = TRUE) ; library("lubridate")
if(!require("stringr")) install.packages("stringr", quiet = TRUE) ; library("stringr")
if(!require("stringi")) install.packages("stringi", quiet = TRUE) ; library("stringi")
if(!require("magrittr")) install.packages("magrittr", quiet = TRUE) ; library("magrittr")
if(!require("reshape2")) install.packages("reshape2", quiet = TRUE) ; library("reshape2")
if(!require("ggrepel")) install.packages("ggrepel", quiet = TRUE) ; library("ggrepel")   
if(!require("geomtextpath")) install.packages("geomtextpath", quiet = TRUE) ; library("geomtextpath") 
if(!require("ggtext")) install.packages("ggtext", quiet = TRUE) ; library("ggtext")
if(!require("patchwork")) install.packages("patchwork", quiet = TRUE) ; library("patchwork")
if(!require("corrplot")) install.packages("corrplot", quiet = TRUE) ; library("corrplot")   
if(!require("viridis")) install.packages("viridis", quiet = TRUE) ; library("viridis")   
if(!require("showtext")) install.packages("showtext", quiet = TRUE) ; library("showtext")

# ------------------------------------------------------------------------------
# C. Modelagem Estatística e Cálculos Específicos
# ------------------------------------------------------------------------------

if(!require("stats")) install.packages("stats", quiet = TRUE) ; library("stats")   
if(!require("nlme")) install.packages("nlme", quiet = TRUE) ; library("nlme")        
if(!require("broom")) install.packages("broom", quiet = TRUE) ; library("broom")
if(!require("bizdays")) install.packages("bizdays", quiet = TRUE) ; library("bizdays")
if(!require("survival")) install.packages("survival", quiet = TRUE) ; library("survival")
if(!require("survminer")) install.packages("survminer", quiet = TRUE) ; library("survminer")
if(!require("forecast")) install.packages("forecast", quiet = TRUE) ; library("forecast")
if(!require("psych")) install.packages("psych", quiet = TRUE) ; library("psych")
if(!require("skimr")) install.packages("skimr", quiet = TRUE) ; library("skimr")
if(!require("Hmisc")) install.packages("Hmisc", quiet = TRUE) ; library("Hmisc")

# ------------------------------------------------------------------------------
# D. Apresentação de Resultados, Relatórios e Interatividade
# ------------------------------------------------------------------------------

# ------------------------------------------------------------------------------
# D. Apresentação de Resultados, Relatórios e Interatividade
# ------------------------------------------------------------------------------

if(!require("DT")) install.packages("DT", quiet = TRUE) ; library("DT")          
if(!require("reactable")) install.packages("reactable", quiet = TRUE) ; library("reactable")
if(!require("kableExtra")) install.packages("kableExtra", quiet = TRUE) ; library("kableExtra")
if(!require("flextable")) install.packages("flextable", quiet = TRUE) ; library("flextable")

# --- DEPENDÊNCIAS ESSENCIAIS PARA O FLEXTABLE (Evita erro no Quarto) ---
if(!require("gdtools")) install.packages("gdtools", quiet = TRUE) ; library("gdtools")
if(!require("systemfonts")) install.packages("systemfonts", quiet = TRUE) ; library("systemfonts")

if(!require("officer")) install.packages("officer", quiet = TRUE) ; library("officer")
if(!require("htmltools")) install.packages("htmltools", quiet = TRUE) ; library("htmltools")
if(!require("sjPlot")) install.packages("sjPlot", quiet = TRUE) ; library("sjPlot")
if(!require("fdth")) install.packages("fdth", quiet = TRUE) ; library("fdth")
if(!require("cli")) install.packages("cli", quiet = TRUE) ; library("cli")

# --- ADICIONADOS PARA O SEU GRÁFICO DINÂMICO ---
if(!require("plotly")) install.packages("plotly", quiet = TRUE) ; library("plotly")   # Motor interativo
if(!require("tidyr")) install.packages("tidyr", quiet = TRUE) ; library("tidyr")     # Reorganização de dados (pivot)
if(!require("dplyr")) install.packages("dplyr", quiet = TRUE) ; library("dplyr")     # Manipulação de dados

# ==============================================================================
# E. FUNÇÕES DE APRESENTAÇÃO
# ==============================================================================
# 
# tabela_interativa <- function(dados, 
#                                titulo_tabela, 
#                                tam_fonte_corpo = "13px",   
#                                tam_fonte_titulo = "20px",  
#                                tam_fonte_header = "14px",  
#                                cor_titulo = "#03045e",     
#                                cor_primaria = "#03045e",   
#                                cor_texto_corpo = "#333333",
#                                mostrar_filtro = TRUE,      
#                                pesquisa_geral = FALSE,     
#                                largura_cols_vetor = NULL,  
#                                colunas_selecionadas = NULL,
#                                n_pages = 10,               
#                                mostrar_indice = TRUE) { 
# 
#   # Inicializa o contador global para numerar as tabelas automaticamente
#   if (!base::exists("contador_tabelas_alex")) {
#     base::assign("contador_tabelas_alex", 0, envir = .GlobalEnv)
#   }
# 
#   # Processa a seleção de colunas se o usuário forneceu o vetor
#   dados_processados <- dados
#   if (!base::is.null(colunas_selecionadas)) {
#     dados_processados <- dados %>% dplyr::select(tidyselect::all_of(colunas_selecionadas))
#   }
# 
#   # Prevenção de Erro '7': Verifica o número de colunas antes de aplicar larguras
#   n_colunas_dados <- base::ncol(dados_processados)
#   lista_columnDefs <- base::list(base::list(width = '30px', targets = 0))
#   
#   if (!base::is.null(largura_cols_vetor)) {
#     for (i in base::seq_along(largura_cols_vetor)) {
#       if ((i - 1) < n_colunas_dados) {
#           lista_columnDefs[[base::length(lista_columnDefs) + 1]] <- base::list(
#             width = largura_cols_vetor[i], 
#             targets = i - 1
#           )
#       }
#     }
#   }
# 
#   # Incrementa o contador para o título
#   base::assign("contador_tabelas_alex", base::get("contador_tabelas_alex", envir = .GlobalEnv) + 1, envir = .GlobalEnv)
#   titulo_final <- base::paste0("Tabela ", base::get("contador_tabelas_alex", envir = .GlobalEnv), ": ", titulo_tabela)
# 
#   # Renderiza o título H2 com seu estilo original
#   html_titulo <- htmltools::tags$h2(
#     style = base::paste0("color: ", cor_titulo, "; font-size: ", tam_fonte_titulo, 
#                           "; font-weight: bold; text-align: left; margin-bottom: 10px;"),
#     htmltools::tags$b(titulo_final)
#   )
# 
#   # Criação da DT
#   tabela <- DT::datatable(
#     base::data.frame(dados_processados, check.names = FALSE),
#     escape = FALSE, 
#     rownames = mostrar_indice,
#     filter = if(mostrar_filtro) base::list(position = "top", clear = TRUE, plain = TRUE) else "none",
#     width = "100%", 
#     class = "hover row-border", 
#     options = base::list(
#       # CORREÇÃO AQUI: Dinâmico conforme sua escolha
#       dom = if(pesquisa_geral) 'ft p' else 't p',
#       pageLength = n_pages,
#       searching = TRUE, 
#       lengthChange = FALSE,
#       info = FALSE,
#       ordering = FALSE,      
#       autoWidth = FALSE,    
#       scrollX = TRUE,       
#       columnDefs = lista_columnDefs,
#       initComplete = DT::JS(
#         base::paste0("function(settings, json) {",
#                       # Alinhamento à esquerda, Negrito e Margens da Barra de Pesquisa
#                       "$(this.api().table().container()).find('.dataTables_filter').css({",
#                       "  'float': 'left', 'text-align': 'left', 'font-weight': 'bold',",
#                       "  'margin-top': '15px', 'margin-bottom': '15px'",
#                       "});",
#                       # Estilo do corpo e cabeçalho (Seu estilo original de 3px e fundo branco)
#                       "$(this.api().table().container()).css({'font-size': '", tam_fonte_corpo, "', 'font-family': 'Arial, sans-serif', 'color': '", cor_texto_corpo, "'});",
#                       "$(this.api().table().header()).css({'font-size': '", tam_fonte_header, "', 'background-color': '#ffffff', 'color': '", cor_primaria, "', 'white-space': 'nowrap'});",
#                       "$(this.api().table().header()).find('tr:first-child th').css({'border-top': '3px solid #000000', 'border-bottom': '3px solid #000000', 'padding': '12px'});",
#                       "$(this.api().table().node()).css({'border-bottom': '3px solid #000000'});",
#                       # Efeito Hover Alex: Negrito apenas na tabela principal
#                       "$(this.api().table().body()).on('mouseenter', 'tr', function() {",
#                       "  if (!$(this).closest('table').hasClass('subtable')) {",
#                       "    $(this).css({'background-color': '#ffffff', 'color': '#000000', 'font-weight': 'bold'});",
#                       "  }",
#                       "}).on('mouseleave', 'tr', function() {",
#                       "  if (!$(this).closest('table').hasClass('subtable')) {",
#                       "    $(this).css({'background-color': '', 'color': '", cor_texto_corpo, "', 'font-weight': 'normal'});",
#                       "  }",
#                       "});",
#                       "}")
#       ),
#       language = base::list(paginate = base::list("previous" = "Anterior", "next" = "Próximo"),
#                             emptyTable = "Sem dados", zeroRecords = "Nenhum registro encontrado", search = "Pesquisa Geral:")
#     )
#   )
#   return(htmltools::tagList(html_titulo, tabela))
# }

tabela_interativa <- function(dados, 
                               titulo_tabela, 
                               tam_fonte_corpo = "13px",   
                               tam_fonte_titulo = "20px",  
                               tam_fonte_header = "14px",  
                               cor_titulo = "#03045e",     
                               cor_primaria = "#03045e",   
                               cor_texto_corpo = "#333333",
                               mostrar_filtro = TRUE,      
                               pesquisa_geral = FALSE,     
                               largura_cols_vetor = NULL,  
                               colunas_selecionadas = NULL,
                               alinhamento_header_vetor = NULL, # Adicionado
                               alinhamento_corpo_vetor = NULL,  # Adicionado
                               n_pages = 10,               
                               mostrar_indice = TRUE) { 

  # Inicializa o contador global para numerar as tabelas automaticamente
  if (!base::exists("contador_tabelas_alex")) {
    base::assign("contador_tabelas_alex", 0, envir = .GlobalEnv)
  }

  # Processa a seleção de colunas se o usuário forneceu o vetor
  dados_processados <- dados
  if (!base::is.null(colunas_selecionadas)) {
    dados_processados <- dados %>% dplyr::select(tidyselect::all_of(colunas_selecionadas))
  }

  n_colunas_dados <- base::ncol(dados_processados)
  
  # --- LOGICA DE COLUMN DEFS (LARGURAS E ALINHAMENTO DO CORPO) ---
  lista_columnDefs <- base::list()
  
  # Se mostrar índice, a coluna 0 é o índice, senão os dados começam no 0
  offset <- if(mostrar_indice) 1 else 0

  for (i in 1:n_colunas_dados) {
    target_idx <- (i - 1) + offset
    
    # Define alinhamento do corpo
    alin_classe <- if(!base::is.null(alinhamento_corpo_vetor) && i <= base::length(alinhamento_corpo_vetor)) {
      base::paste0("dt-", alinhamento_corpo_vetor[i])
    } else {
      "dt-center" # Default
    }
    
    # Define largura
    largura <- if(!base::is.null(largura_cols_vetor) && i <= base::length(largura_cols_vetor)) largura_cols_vetor[i] else NULL
    
    lista_columnDefs[[base::length(lista_columnDefs) + 1]] <- base::list(
      targets = target_idx,
      width = largura,
      className = alin_classe
    )
  }

  # Incrementa o contador para o título
  base::assign("contador_tabelas_alex", base::get("contador_tabelas_alex", envir = .GlobalEnv) + 1, envir = .GlobalEnv)
  titulo_final <- base::paste0("Tabela ", base::get("contador_tabelas_alex", envir = .GlobalEnv), ": ", titulo_tabela)

  html_titulo <- htmltools::tags$h2(
    style = base::paste0("color: ", cor_titulo, "; font-size: ", tam_fonte_titulo, 
                         "; font-weight: bold; text-align: left; margin-bottom: 10px;"),
    htmltools::tags$b(titulo_final)
  )

  # Prepara alinhamento do Header para o JS
  alin_header_js <- if(!base::is.null(alinhamento_header_vetor)) jsonlite::toJSON(alinhamento_header_vetor) else "null"

  # Criação da DT
  tabela <- DT::datatable(
    base::data.frame(dados_processados, check.names = FALSE),
    escape = FALSE, 
    rownames = mostrar_indice,
    filter = if(mostrar_filtro) base::list(position = "top", clear = TRUE, plain = TRUE) else "none",
    width = "100%", 
    class = "hover row-border", 
    options = base::list(
      dom = if(pesquisa_geral) 'ft p' else 't p',
      pageLength = n_pages,
      searching = TRUE, 
      lengthChange = FALSE,
      info = FALSE,
      ordering = FALSE,      
      autoWidth = FALSE,    
      scrollX = TRUE,       
      columnDefs = lista_columnDefs,
      initComplete = DT::JS(
        base::paste0("function(settings, json) {",
                     "$(this.api().table().container()).find('.dataTables_filter').css({",
                     "  'float': 'left', 'text-align': 'left', 'font-weight': 'bold',",
                     "  'margin-top': '15px', 'margin-bottom': '15px'",
                     "});",
                     "$(this.api().table().container()).css({'font-size': '", tam_fonte_corpo, "', 'font-family': 'Arial, sans-serif', 'color': '", cor_texto_corpo, "'});",
                     
                     # Estilo do Header e Quebra de Linha
                     "$(this.api().table().header()).css({",
                     "  'font-size': '", tam_fonte_header, "', ",
                     "  'background-color': '#ffffff', ",
                     "  'color': '", cor_primaria, "', ",
                     "  'white-space': 'normal'", 
                     "});",
                     
                     "$(this.api().table().header()).find('tr:first-child th').css({",
                     "  'border-top': '3px solid #000000', 'border-bottom': '3px solid #000000', 'padding': '12px', 'vertical-align': 'middle'",
                     "});",
                     
                     # --- LOGICA DE ALINHAMENTO DO HEADER ---
                     "var alinHeaders = ", alin_header_js, ";",
                     "var offsetHeader = ", offset, ";",
                     "$(this.api().table().header()).find('tr:first-child th').each(function(index) {",
                     "  if(alinHeaders && index >= offsetHeader && alinHeaders[index - offsetHeader]) {",
                     "    $(this).css('text-align', alinHeaders[index - offsetHeader]);",
                     "  } else { $(this).css('text-align', 'center'); }",
                     "});",

                     "$(this.api().table().node()).css({'border-bottom': '3px solid #000000'});",
                     
                     "$(this.api().table().body()).on('mouseenter', 'tr', function() {",
                     "  if (!$(this).closest('table').hasClass('subtable')) {",
                     "    $(this).css({'background-color': '#ffffff', 'color': '#000000', 'font-weight': 'bold'});",
                     "  }",
                     "}).on('mouseleave', 'tr', function() {",
                     "  if (!$(this).closest('table').hasClass('subtable')) {",
                     "    $(this).css({'background-color': '', 'color': '", cor_texto_corpo, "', 'font-weight': 'normal'});",
                     "  }",
                     "});",
                     "}")
      ),
      language = base::list(paginate = base::list("previous" = "Anterior", "next" = "Próximo"),
                            emptyTable = "Sem dados", zeroRecords = "Nenhum registro encontrado", search = "Pesquisa Geral:")
    )
  )
  return(htmltools::tagList(html_titulo, tabela))
}

# 
# 
# tabela_interativa_detalhes <- function(dados, 
#                                         dados_detalhes, 
#                                         coluna_chave, 
#                                         titulo_tabela, 
#                                         colunas_detalhes_nomes = NULL, 
#                                         largura_detalhes_vetor = NULL, 
#                                         tam_fonte_corpo = "13px",   
#                                         tam_fonte_titulo = "20px",  
#                                         tam_fonte_header = "14px",  
#                                         cor_titulo = "#03045e",     
#                                         cor_primaria = "#03045e",   
#                                         cor_texto_corpo = "#333333",
#                                         mostrar_filtro = TRUE,      
#                                         pesquisa_geral = FALSE,     
#                                         largura_cols_vetor = NULL,  
#                                         colunas_selecionadas = NULL,
#                                         n_pages = 10,               
#                                         mostrar_indice = TRUE) {
# 
#   if (!base::exists("contador_tabelas_alex", envir = .GlobalEnv)) {
#     base::assign("contador_tabelas_alex", 0, envir = .GlobalEnv)
#   }
# 
#   dados_processados <- dados
#   if (!base::is.null(colunas_selecionadas)) {
#     dados_processados <- dados %>% dplyr::select(tidyselect::all_of(colunas_selecionadas))
#   }
# 
#   dados_processados <- base::cbind(' ' = '&oplus;', dados_processados)
#   n_colunas_reais <- base::ncol(dados_processados)
# 
#   base::assign("contador_tabelas_alex", base::get("contador_tabelas_alex", envir = .GlobalEnv) + 1, envir = .GlobalEnv)
#   titulo_final <- base::paste0("Tabela ", base::get("contador_tabelas_alex", envir = .GlobalEnv), ": ", titulo_tabela)
# 
#   html_titulo <- htmltools::tags$h2(
#     style = base::paste0("color: ", cor_titulo, "; font-size: ", tam_fonte_titulo, 
#                          "; font-weight: bold; text-align: left; margin-bottom: 10px;"),
#     htmltools::tags$b(titulo_final)
#   )
# 
#   
#   
#   json_detalhes_js <- jsonlite::toJSON(dados_detalhes, ArrayOrder = "row")
#   nomes_detalhes_js <- if(!base::is.null(colunas_detalhes_nomes)) jsonlite::toJSON(colunas_detalhes_nomes) else "null"
#   larguras_detalhes_js <- if(!base::is.null(largura_detalhes_vetor)) jsonlite::toJSON(largura_detalhes_vetor) else "null"
#   # nomes_detalhes_js <- if(!base::is.na(colunas_detalhes_nomes) && !base::is.null(colunas_detalhes_nomes)) jsonlite::toJSON(colunas_detalhes_nomes) else "null"
#   # larguras_detalhes_js <- if(!base::is.na(largura_detalhes_vetor) && !base::is.null(largura_detalhes_vetor)) jsonlite::toJSON(largura_detalhes_vetor) else "null"
# 
#   lista_column_defs <- base::list(
#     base::list(targets = 0, className = 'details-control', width = '20px', orderable = FALSE)
#   )
#   
#   if (!base::is.null(largura_cols_vetor)) {
#     for (i in 1:base::length(largura_cols_vetor)) {
#       if (i < n_colunas_reais) {
#         lista_column_defs[[base::length(lista_column_defs) + 1]] <- base::list(targets = i, width = largura_cols_vetor[i])
#       }
#     }
#   }
# 
#   tabela <- DT::datatable(
#     base::data.frame(dados_processados, check.names = FALSE),
#     escape = FALSE, 
#     rownames = mostrar_indice,
#     filter = if(mostrar_filtro) base::list(position = "top", clear = TRUE, plain = TRUE) else "none",
#     width = "100%", 
#     class = "row-border", 
#     options = base::list(
#       dom = if(pesquisa_geral) 'ft p' else 't p',
#       pageLength = n_pages,
#       searching = TRUE, 
#       lengthChange = FALSE,
#       info = FALSE,
#       ordering = FALSE,      
#       autoWidth = FALSE,    
#       scrollX = TRUE,
#       columnDefs = lista_column_defs,
#       
#       initComplete = DT::JS(
#         base::paste0("function(settings, json) {",
#                       "$(this.api().table().container()).find('.dataTables_filter').css({",
#                       "  'float': 'left', 'text-align': 'left', 'font-weight': 'bold',",
#                       "  'margin-top': '15px', 'margin-bottom': '15px'",
#                       "});",
#                       "$(this.api().table().container()).css({'font-size': '", tam_fonte_corpo, "', 'font-family': 'Arial, sans-serif', 'color': '", cor_texto_corpo, "'});",
#                       "$(this.api().table().header()).css({'font-size': '", tam_fonte_header, "', 'background-color': '#ffffff', 'color': '", cor_primaria, "', 'white-space': 'nowrap'});",
#                       "$(this.api().table().header()).find('tr:first-child th').css({'border-top': '3px solid #000000', 'border-bottom': '3px solid #000000', 'padding': '12px'});",
#                       "$(this.api().table().node()).css({'border-bottom': '3px solid #000000'});",
#                       
#                       "var table = this.api(); var detalhes_data = ", json_detalhes_js, ";",
#                       "var customNomes = ", nomes_detalhes_js, "; var customLarguras = ", larguras_detalhes_js, ";",
#                       
#                       "$(this.api().table().body()).on('click', 'td.details-control', function() {",
#                       "  var tr = $(this).closest('tr'); var row = table.row(tr);",
#                       "  if (row.child.isShown()) {",
#                       "    row.child.hide(); tr.removeClass('shown'); $(this).html('&oplus;');",
#                       "    tr.css({'background-color': '', 'color': '", cor_texto_corpo, "', 'font-weight': 'normal', 'border-left': ''});",
#                       "  } else {",
#                       "    tr.css({'background-color': '#f8f9fa', 'color': '", cor_primaria, "', 'font-weight': '600', 'border-left': '4px solid ", cor_primaria, "'});",
#                       "    var rowData = row.data(); var indexChave = ", if(mostrar_indice) "2" else "1", "; var chave = rowData[indexChave];",
#                       "    var sub_dados = detalhes_data.filter(d => d['", coluna_chave, "'] == chave);",
#                       
#                       "    var html_sub = '<table class=\"subtable\" style=\"width:97%; margin-left:3%; border-collapse: collapse;\"><thead><tr style=\"background:#ffffff !important; color:#03045e; font-weight:bold;\">';",
#                       "    if(sub_dados.length > 0) {",
#                       "       var colKeys = Object.keys(sub_dados[0]).filter(k => k !== '", coluna_chave, "');",
#                       "       colKeys.forEach((key, index) => {",
#                       "          var label = (customNomes && customNomes[index]) ? customNomes[index] : key;",
#                       "          var width = (customLarguras && customLarguras[index]) ? 'width:'+customLarguras[index]+';' : '';",
#                       "          html_sub += '<th style=\"padding:6px; border-bottom:1px solid #ddd; text-align:left; '+width+'\">' + label + '</th>';",
#                       "       });",
#                       "       html_sub += '</tr></thead><tbody>';",
#                       "       sub_dados.forEach(r => {",
#                       "          html_sub += '<tr class=\"subrow\" style=\"border-bottom:1px solid #f1f1f1; background-color: transparent !important;\">';",
#                       "          colKeys.forEach(k => { html_sub += '<td style=\"padding:6px; color:#333 !important; font-weight: normal !important;\">' + (r[k] || '') + '</td>'; });",
#                       "          html_sub += '</tr>';",
#                       "       });",
#                       "    } else { html_sub += '<tr><td>Nenhum detalhe disponível</td></tr>'; }",
#                       "    html_sub += '</tbody></table>';",
#                       "    row.child(html_sub).show(); tr.addClass('shown'); $(this).html('&ominus;');",
#                       "  }",
#                       "});",
#                       
#                       "$(this.api().table().body()).on('mouseenter', 'tr', function(e) {",
#                       "  var tr = $(this);",
#                       "  if (!tr.hasClass('shown') && !tr.closest('table').hasClass('subtable') && !tr.hasClass('subrow')) {",
#                       "    tr.css({'background-color': '#ffffff', 'color': '#000000', 'font-weight': 'bold'});",
#                       "  }",
#                       "}).on('mouseleave', 'tr', function(e) {",
#                       "  var tr = $(this);",
#                       "  if (!tr.hasClass('shown') && !tr.closest('table').hasClass('subtable') && !tr.hasClass('subrow')) {",
#                       "    tr.css({'background-color': '', 'color': '", cor_texto_corpo, "', 'font-weight': 'normal'});",
#                       "  }",
#                       "});",
#                       "}")
#       ),
#       language = base::list(paginate = base::list("previous" = "Anterior", "next" = "Próximo"), search = "Pesquisa Geral:")
#     )
#   )
#   return(htmltools::tagList(html_titulo, tabela))
# }

tabela_interativa_detalhes <- function(dados, 
                                       dados_detalhes, 
                                       coluna_chave, 
                                       titulo_tabela, 
                                       colunas_detalhes_nomes = NULL, 
                                       largura_detalhes_vetor = NULL, 
                                       tam_fonte_corpo = "13px",   
                                       tam_fonte_titulo = "20px",  
                                       tam_fonte_header = "14px",  
                                       cor_titulo = "#03045e",     
                                       cor_primaria = "#03045e",   
                                       cor_texto_corpo = "#333333",
                                       mostrar_filtro = TRUE,      
                                       pesquisa_geral = FALSE,     
                                       largura_cols_vetor = NULL,  
                                       colunas_selecionadas = NULL,
                                       alinhamento_header_vetor = NULL, # Novo parâmetro
                                       alinhamento_corpo_vetor = NULL,  # Novo parâmetro
                                       n_pages = 10,               
                                       mostrar_indice = TRUE) {

  if (!base::exists("contador_tabelas_alex", envir = .GlobalEnv)) {
    base::assign("contador_tabelas_alex", 0, envir = .GlobalEnv)
  }

  dados_processados <- dados
  if (!base::is.null(colunas_selecionadas)) {
    dados_processados <- dados %>% dplyr::select(tidyselect::all_of(colunas_selecionadas))
  }

  dados_processados <- base::cbind(' ' = '&oplus;', dados_processados)
  n_colunas_reais <- base::ncol(dados_processados)

  base::assign("contador_tabelas_alex", base::get("contador_tabelas_alex", envir = .GlobalEnv) + 1, envir = .GlobalEnv)
  titulo_final <- base::paste0("Tabela ", base::get("contador_tabelas_alex", envir = .GlobalEnv), ": ", titulo_tabela)

  html_titulo <- htmltools::tags$h2(
    style = base::paste0("color: ", cor_titulo, "; font-size: ", tam_fonte_titulo, 
                         "; font-weight: bold; text-align: left; margin-bottom: 10px;"),
    htmltools::tags$b(titulo_final)
  )

  json_detalhes_js <- jsonlite::toJSON(dados_detalhes, ArrayOrder = "row")
  nomes_detalhes_js <- if(!base::is.null(colunas_detalhes_nomes)) jsonlite::toJSON(colunas_detalhes_nomes) else "null"
  larguras_detalhes_js <- if(!base::is.null(largura_detalhes_vetor)) jsonlite::toJSON(largura_detalhes_vetor) else "null"

  # --- CONFIGURAÇÃO DE COLUMN DEFS (LARGURAS E ALINHAMENTO DO CORPO) ---
  lista_column_defs <- base::list(
    base::list(targets = 0, className = 'details-control', width = '20px', orderable = FALSE)
  )
  
  # Lógica de Alinhamento do Corpo
  for (i in 1:(n_colunas_reais - 1)) {
    # Se o usuário passou um vetor de alinhamento, usa ele (índice i pq a col 0 é o controle)
    alin_classe <- if(!base::is.null(alinhamento_corpo_vetor) && i <= base::length(alinhamento_corpo_vetor)) {
      base::paste0("dt-", alinhamento_corpo_vetor[i])
    } else {
      "dt-center" # Default
    }
    
    # Se o usuário passou largura
    largura <- if(!base::is.null(largura_cols_vetor) && i <= base::length(largura_cols_vetor)) largura_cols_vetor[i] else NULL
    
    lista_column_defs[[base::length(lista_column_defs) + 1]] <- base::list(
      targets = i, 
      className = alin_classe,
      width = largura
    )
  }

  # Lógica de Alinhamento do Header (JS)
  alin_header_js <- if(!base::is.null(alinhamento_header_vetor)) {
    jsonlite::toJSON(alinhamento_header_vetor)
  } else {
    "null"
  }

  tabela <- DT::datatable(
    base::data.frame(dados_processados, check.names = FALSE),
    escape = FALSE, 
    rownames = mostrar_indice,
    filter = if(mostrar_filtro) base::list(position = "top", clear = TRUE, plain = TRUE) else "none",
    width = "100%", 
    class = "row-border", 
    options = base::list(
      dom = if(pesquisa_geral) 'ft p' else 't p',
      pageLength = n_pages,
      searching = TRUE, 
      lengthChange = FALSE,
      info = FALSE,
      ordering = FALSE,      
      autoWidth = FALSE,    
      scrollX = TRUE,
      columnDefs = lista_column_defs,
      
      initComplete = DT::JS(
        base::paste0("function(settings, json) {",
                     "$(this.api().table().container()).find('.dataTables_filter').css({",
                     "  'float': 'left', 'text-align': 'left', 'font-weight': 'bold',",
                     "  'margin-top': '15px', 'margin-bottom': '15px'",
                     "});",
                     "$(this.api().table().container()).css({'font-size': '", tam_fonte_corpo, "', 'font-family': 'Arial, sans-serif', 'color': '", cor_texto_corpo, "'});",
                     
                     # Estilo Geral do Header
                     "$(this.api().table().header()).css({",
                     "  'font-size': '", tam_fonte_header, "', ",
                     "  'background-color': '#ffffff', ",
                     "  'color': '", cor_primaria, "', ",
                     "  'white-space': 'normal'", 
                     "});",
                     
                     "$(this.api().table().header()).find('tr:first-child th').css({",
                     "  'border-top': '3px solid #000000', ",
                     "  'border-bottom': '3px solid #000000', ",
                     "  'padding': '12px',",
                     "  'vertical-align': 'middle'",
                     "});",
                     
                     # Alinhamento individual do Header
                     "var alinHeaders = ", alin_header_js, ";",
                     "if(alinHeaders) {",
                     "  $(this.api().table().header()).find('tr:first-child th').each(function(index) {",
                     "    if(index > 0 && alinHeaders[index-1]) {",
                     "      $(this).css('text-align', alinHeaders[index-1]);",
                     "    } else { $(this).css('text-align', 'center'); }",
                     "  });",
                     "} else {",
                     "  $(this.api().table().header()).find('tr:first-child th').css('text-align', 'center');",
                     "}",
                     
                     "$(this.api().table().node()).css({'border-bottom': '3px solid #000000'});",
                      
                      "var table = this.api(); var detalhes_data = ", json_detalhes_js, ";",
                      "var customNomes = ", nomes_detalhes_js, "; var customLarguras = ", larguras_detalhes_js, ";",
                      
                      "$(this.api().table().body()).on('click', 'td.details-control', function() {",
                      "  var tr = $(this).closest('tr'); var row = table.row(tr);",
                      "  if (row.child.isShown()) {",
                      "    row.child.hide(); tr.removeClass('shown'); $(this).html('&oplus;');",
                      "    tr.css({'background-color': '', 'color': '", cor_texto_corpo, "', 'font-weight': 'normal', 'border-left': ''});",
                      "  } else {",
                      "    tr.css({'background-color': '#f8f9fa', 'color': '", cor_primaria, "', 'font-weight': '600', 'border-left': '4px solid ", cor_primaria, "'});",
                      "    var rowData = row.data(); var indexChave = ", if(mostrar_indice) "2" else "1", "; var chave = rowData[indexChave];",
                      "    var sub_dados = detalhes_data.filter(d => d['", coluna_chave, "'] == chave);",
                      
                      "    var html_sub = '<table class=\"subtable\" style=\"width:97%; margin-left:3%; border-collapse: collapse;\"><thead><tr style=\"background:#ffffff !important; color:#03045e; font-weight:bold;\">';",
                      "    if(sub_dados.length > 0) {",
                      "       var colKeys = Object.keys(sub_dados[0]).filter(k => k !== '", coluna_chave, "');",
                      "       colKeys.forEach((key, index) => {",
                      "          var label = (customNomes && customNomes[index]) ? customNomes[index] : key;",
                      "          var width = (customLarguras && customLarguras[index]) ? 'width:'+customLarguras[index]+';' : '';",
                      "          html_sub += '<th style=\"padding:6px; border-bottom:1px solid #ddd; text-align:center; vertical-align:middle; '+width+'\">' + label + '</th>';",
                      "       });",
                      "       html_sub += '</tr></thead><tbody>';",
                      "       sub_dados.forEach(r => {",
                      "          html_sub += '<tr class=\"subrow\" style=\"border-bottom:1px solid #f1f1f1; background-color: transparent !important;\">';",
                      "          colKeys.forEach(k => { html_sub += '<td style=\"padding:6px; color:#333 !important; font-weight: normal !important; text-align:center;\">' + (r[k] || '') + '</td>'; });",
                      "          html_sub += '</tr>';",
                      "       });",
                      "    } else { html_sub += '<tr><td>Nenhum detalhe disponível</td></tr>'; }",
                      "    html_sub += '</tbody></table>';",
                      "    row.child(html_sub).show(); tr.addClass('shown'); $(this).html('&ominus;');",
                      "  }",
                      "});",
                      
                      "$(this.api().table().body()).on('mouseenter', 'tr', function(e) {",
                      "  var tr = $(this);",
                      "  if (!tr.hasClass('shown') && !tr.closest('table').hasClass('subtable') && !tr.hasClass('subrow')) {",
                      "    tr.css({'background-color': '#ffffff', 'color': '#000000', 'font-weight': 'bold'});",
                      "  }",
                      "}).on('mouseleave', 'tr', function(e) {",
                      "  var tr = $(this);",
                      "  if (!tr.hasClass('shown') && !tr.closest('table').hasClass('subtable') && !tr.hasClass('subrow')) {",
                      "    tr.css({'background-color': '', 'color': '", cor_texto_corpo, "', 'font-weight': 'normal'});",
                      "  }",
                      "});",
                      "}")
      ),
      language = base::list(paginate = base::list("previous" = "Anterior", "next" = "Próximo"), search = "Pesquisa Geral:")
    )
  )
  return(htmltools::tagList(html_titulo, tabela))
}

# ==============================================================================
# F. FUNÇÕES DE TRATAMENTO E AUDITORIA
# ==============================================================================

# 3.1. Padroniza Datas
padronizar.data <- function(x) { 
  data_convertida <- base::suppressWarnings(lubridate::parse_date_time(x, orders = base::c("mdy", "dmy", "ymd")))
  data_final <- base::as.Date(data_convertida)
  return(dplyr::if_else(base::is.na(data_final), base::Sys.Date(), data_final))
}

# 3.2. Padroniza Categorias Nominais
padronizar.categorias.nominais <- function(x, caixa_alta = FALSE) {
  res <- base::as.character(stringr::str_trim(x))
  if (caixa_alta) {
    res <- stringr::str_to_upper(res) 
  } else {
    res <- stringr::str_to_title(res) 
  }
  return(base::as.factor(res))
}

# 3.3. Padroniza Valores Financeiros
padronizar.valores <- function(x) {
  res <- stringr::str_remove_all(x, "R\\$|\\.")  
  res <- stringr::str_replace_all(res, ",", ".") 
  return(base::as.numeric(stringr::str_trim(res)))
}

# 3.4. Auditoria de Integridade (Duplicados)
verificar.duplicados <- function(dados, coluna) {
  duplicados <- dados %>%
    dplyr::group_by(.data[[coluna]]) %>%
    dplyr::filter(dplyr::n() > 1) %>%
    dplyr::arrange(.data[[coluna]])
  
  total_dups <- base::nrow(duplicados)
  
  if (total_dups > 0) {
    cli::cli_h1(" Auditoria de Integridade ")
    cli::cli_alert_danger("ALERTA: Identificadas {total_dups} linhas duplicadas na coluna {.field {coluna}}.")
    
    cli::cli_alert_info("Gerando relatório PDF de auditoria...")
    duplicados %>%
      kableExtra::kbl(caption = base::paste("Relatório de Itens Duplicados - Coluna:", coluna)) %>%
      kableExtra::kable_styling(latex_options = base::c("striped", "hold_position")) %>%
      kableExtra::save_kable(base::paste0("Relatorio_Duplicados_", coluna, ".pdf"))
    
    cli::cli_alert_success("Relatório salvo: {.file Relatorio_Duplicados_{coluna}.pdf}")
    cli::cli_rule()
    utils::View(duplicados, title = base::paste0("Auditoria_", coluna))
  } else {
    cli::cli_h1(" Auditoria de Integridade ")
    cli::cli_alert_success("INTEGRIDADE VALIDADA: Nenhuma duplicata encontrada na coluna {.field {coluna}}.")
    cli::cli_rule()
  }
}

# 3.5. Cálculo de dias úteis
calcular_dias_uteis_alex <- function(inicio, fim) {
  if (base::is.na(inicio) || base::is.na(fim) || fim < inicio) {
    return(0) 
  }
  dias <- base::seq(inicio, fim, by = "day")
  return(base::sum(!lubridate::wday(dias) %in% base::c(1, 7)))
}

# 3.6. Verificar Inconsistência Cronológica
verificar.cronologia <- function(dados, col_entrada = "data_de_entrada", col_saida = "data_de_saida") {
  erros_data <- dados %>%
    dplyr::filter(.data[[col_saida]] < .data[[col_entrada]])
  
  total_erros <- base::nrow(erros_data)
  
  if (total_erros > 0) {
    cli::cli_h1(" Auditoria de Cronologia ")
    cli::cli_alert_danger("ALERTA: Encontrados {total_erros} registros com data de saída anterior à entrada.")
    
    cli::cli_alert_info("Gerando relatório de erros de data...")
    erros_data %>%
      kableExtra::kbl(caption = "Erros de Cronologia (Saída < Entrada)") %>%
      kableExtra::kable_styling(latex_options = base::c("striped", "hold_position")) %>%
      kableExtra::save_kable("Relatorio_Erro_Cronologia.pdf")
    
    cli::cli_alert_success("Relatório salvo: {.file Relatorio_Erro_Cronologia.pdf}")
    cli::cli_rule()
    utils::View(erros_data, title = "Erros_Cronologia")
  } else {
    cli::cli_h1(" Auditoria de Cronologia ")
    cli::cli_alert_success("INTEGRIDADE CRONOLÓGICA VALIDADA: Todas as saídas são posteriores às entradas.")
    cli::cli_rule()
  }
}

cli::cli_alert_success("Ambiente e Funções de Tratamento carregados com sucesso!")
```

:::

## Estrutura Organizacional

### Equipe Técnica

::: {style="font-size: 0.9em; text-align: justify; border-left: 4px solid #000000; padding-left: 15px; margin-top: 25px; margin-bottom: 25px; "}

| Função | Responsável |
|:--- |:--- |
| **Subgerente** | Rodrigo Ferreira Andrade |
| **Assistente Administrativo** | Daniel Andrade |
| **Assistente Administrativo** | José Victor |
| **Estagiário I** | Fernanda Viana |

:::

### Escopo de Atuação

::: {style="text-align: justify; margin-top: 25px; margin-bottom: 25px; "}

O setor atua de forma estratégica na coordenação e execução de compras e contratações, com foco em:

:::

::: {style="text-align: justify; border-left: 4px solid #000000; padding-left: 15px; margin-top: 15px; margin-bottom: 20px; "}

* **Planejamento:** Colaboração na elaboração do Plano de Contratações Anual (PCA).
* **Conformidade:** Análise técnica de Projetos Básicos e Termos de Referência.
* **Monitoramento:** Acompanhamento em tempo real do status processual junto aos órgãos externos.
* **Modernização:** Contribuição ativa em políticas de gestão administrativa.
:::

## Repositório de Dados e Central de Downloads

<!-- Importação das bases de dados -->

::: {style="font-size: 0.9em; text-align: justify; margin-top: 25px; margin-bottom: 25px;"}


```{r}
#| label: Importação das bases de dados
#| code-summary: "Importação das bases de dados"

# --- 2. IMPORTAÇÃO E FILTRAGEM INICIAL ---

# 2.1. Base de Processos: Cabeçalho da Operação (Datas, Setores, Agentes)
bd_processos <- gsheet::gsheet2tbl("https://docs.google.com/spreadsheets/d/1UAgVUdYJmIwt0DHRX7mNhkZKpR4nPGyeiUqHirggZ2I/edit?gid=1061612826") |> 
  janitor::clean_names() |> 
  dplyr::filter(!base::is.na(processo),processo != "-",stringr::str_detect(processo, "\\d")) |> 
  dplyr::mutate(
    # Número do processo é um CÓDIGO administrativo
    # Nunca deve ser tratado como número
    processo = as.character(processo),
    # Identificação do agente responsável
    agente = as.character(agente),
    # Modalidade do processo (ex: dispensa, pregão)
    modalidade_processo = as.character(modalidade_processo),
    # Setor demandante
    setor = as.character(setor),
    # Código orçamentário da despesa
    natureza_despesa = as.character(natureza_despesa),
    # Fonte de recurso pode ter espaços extras vindos do Sheets
    fonte_recurso = stringr::str_squish(fonte_recurso),
    # Campo textual livre
    emenda = stringr::str_squish(emenda)
  )

# 2.2. Base de Itens: Detalhamento Financeiro vinculado aos processos
bd_itens <- gsheet::gsheet2tbl("https://docs.google.com/spreadsheets/d/1UAgVUdYJmIwt0DHRX7mNhkZKpR4nPGyeiUqHirggZ2I/edit?gid=1088782695#gid=1088782695") |> 
  janitor::clean_names() |> dplyr::filter(!base::is.na(processo),processo != "-",stringr::str_detect(processo, "\\d")) |> 
  dplyr::mutate(
    # Processo é código administrativo
    processo   = base::as.character(processo),
    # Identificador interno do item
    id         = base::as.numeric(id),
    # Nome do fornecedor
    fornecedor = base::as.character(fornecedor),
    
    # Quantidade adquirida
    # --- TRATAMENTO DE QUANTIDADE ---
    qtde = base::as.numeric(qtde) |> (\(x) dplyr::if_else(base::is.na(x), 0, x))(),
    
    # Valor unitário do item
    # --- TRATAMENTO DE VALOR UNITÁRIO (3 CASAS DECIMAIS E SEM AVISOS) ---
    valor_unitario = valor_unitario |> 
      stringr::str_replace_all("-", "0") |>          
      stringr::str_remove_all("[^0-9,]") |>          
      stringr::str_replace_all(",", ".") |>          
      base::as.numeric() |>                          
      base::round(digits = 3) |>                     # Arredondamento solicitado
      (\(x) dplyr::if_else(base::is.na(x), 0, x))(), 

    # Número da nota de empenho
    nota_de_empenho = stringr::str_squish(nota_de_empenho),
     # Data mantida como texto (pode haver formatos mistos)
     # 
    data_empenho    = stringr::str_squish(data_empenho)
  )



# 2.3. Natureza da Despesa: Dicionário para tradução de códigos contábeis
bd_natureza <- gsheet::gsheet2tbl("https://docs.google.com/spreadsheets/d/1dLUIAM6rL0B5VIftJr3g75L3nOr00KUIJzJzMOON6dg/edit?gid=1685660687") |> 
  janitor::clean_names() |> 
  dplyr::filter(!base::is.na(cod),stringr::str_detect(cod, "\\d")) |> 
  dplyr::mutate(
    # Código da natureza de despesa (sempre texto)
    cod = as.character(cod),
    # Situação da natureza (ATIVA / INATIVA)
    status = toupper(status),
    # Descrição da natureza
    especificacao = stringr::str_squish(especificacao),
    # Código contábil (não é variável numérica)
    conta_contabil = as.character(conta_contabil),
    # Descrição da conta contábil
    conta_contabil_descricao = stringr::str_squish(conta_contabil_descricao)
  )



# 2.4. Fonte de Recurso: Identificação da origem do capital
bd_fonte <- gsheet::gsheet2tbl("https://docs.google.com/spreadsheets/d/1hsBIixCr7wpQqCdl9f43vIAO-dj2G4f6c_wTbuntJMQ/edit?gid=1283626696") |> 
  janitor::clean_names() |> 
  dplyr::filter(!base::is.na(fonte),fonte != "-") |> 
  dplyr::mutate(
    # Código da fonte de recurso
    fonte = stringr::str_trim(fonte),
    # Descrição da fonte
    descricao = stringr::str_squish(descricao),
    # Tipo da fonte (ORDINÁRIO, VINCULADO, etc.)
    tipo = toupper(tipo),
    # Situação da fonte
    situacao = toupper(situacao)
  )



# 2.5. Elemento de Despesa: Classificação detalhada do objeto de gasto
bd_elemento <- gsheet::gsheet2tbl(
  "https://docs.google.com/spreadsheets/d/17OYfesFjT0emcNoZOEyzXuKHm1Ltfv7DMCZdkuX6yOI/edit?gid=323608856") |> 
  janitor::clean_names() |> 
  dplyr::filter(!base::is.na(codigo),stringr::str_detect(codigo, "\\d")) |> 
  dplyr::mutate(
    # Código do elemento (texto categórico)
    codigo = as.character(codigo),
    # Nome do elemento
    elemento = toupper(elemento),
    # Descrição do elemento
    descricao = stringr::str_squish(descricao)
  )



# 2.6. Catálogo e-Compras: Tabela mestra de padronização de itens do Estado
bd_catalogo <- gsheet::gsheet2tbl(
  "https://docs.google.com/spreadsheets/d/1Ywc-hhVPs5lRvmRMe0xKbSQyuca7WmecfRzzScUr7mk/edit?gid=1899552131") |> 
  janitor::clean_names() |> 
  dplyr::filter(!base::is.na(id), id != "-") |> 
  dplyr::mutate(
    # Identificador do item no catálogo
    id = as.numeric(id),
    # Descrição padronizada do item
    descricao = stringr::str_squish(descricao),
    # Padronização textual para evitar inconsistências
    elemento = toupper(elemento),
    grupo = toupper(grupo),
    subgrupo = toupper(subgrupo),
    grupo_item = toupper(grupo_item)
  )

```


<!-- ## Gestão de Fluxos e Indicadores  -->

```{r}

# # 1. PREPARAÇÃO DOS DADOS
# dados_cards <- base::data.frame(
#   titulo    = base::c("Processos", "Itens", "Natureza da Despesa", "Fonte de Recurso", "Elemento de Despesa", "Catálogo e-Compras"),
#   descricao = base::c("Cabeçalho da Operação (Datas, Setores, Agentes)", 
#                       "Detalhamento Financeiro vinculado aos processos", 
#                       "Dicionário para tradução de códigos contábeis", 
#                       "Identificação da origem do capital", 
#                       "Classificação detalhada do objeto de gasto", 
#                       "Tabela mestra de padronização de itens do Estado"),
#   url       = base::c(
#     "https://docs.google.com/spreadsheets/d/1UAgVUdYJmIwt0DHRX7mNhkZKpR4nPGyeiUqHirggZ2I/edit?gid=1061612826",
#     "https://docs.google.com/spreadsheets/d/1UAgVUdYJmIwt0DHRX7mNhkZKpR4nPGyeiUqHirggZ2I/edit?gid=1088782695",
#     "https://docs.google.com/spreadsheets/d/1dLUIAM6rL0B5VIftJr3g75L3nOr00KUIJzJzMOON6dg/edit?gid=1685660687",
#     "https://docs.google.com/spreadsheets/d/1hsBIixCr7wpQqCdl9f43vIAO-dj2G4f6c_wTbuntJMQ/edit?gid=1283626696",
#     "https://docs.google.com/spreadsheets/d/17OYfesFjT0emcNoZOEyzXuKHm1Ltfv7DMCZdkuX6yOI/edit?gid=323608856",
#     "https://docs.google.com/spreadsheets/d/1Ywc-hhVPs5lRvmRMe0xKbSQyuca7WmecfRzzScUr7mk/edit?gid=1899552131"
#   ),
#   stringsAsFactors = FALSE
# )
# 
# # 2. FUNÇÃO PARA GERAR A VITRINE
# gerar_central_cards <- function(df) {
#   
#   estilo_css <- htmltools::tags$style(htmltools::HTML("
#     /* Container com margem superior para o card não cortar ao subir */
#     .container-cards { 
#       display: flex; 
#       flex-wrap: wrap; 
#       gap: 25px; 
#       justify-content: flex-start; 
#       padding-top: 15px; 
#       padding-bottom: 20px;
#       font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
#     }
#     
#     .card-alex { 
#       flex: 1 1 280px;
#       max-width: 320px;
#       border: 1px solid #e0e0e0; 
#       border-top: 4px solid #03045e; 
#       border-radius: 6px; 
#       padding: 20px; 
#       background: #ffffff;
#       box-shadow: 0 2px 4px rgba(0,0,0,0.04); 
#       transition: all 0.3s cubic-bezier(.25,.8,.25,1);
#       display: flex; 
#       flex-direction: column; 
#       justify-content: space-between;
#       position: relative;
#     }
#     
#     /* Efeito de elevação suave */
#     .card-alex:hover { 
#       transform: translateY(-8px); 
#       box-shadow: 0 10px 20px rgba(0,0,0,0.08); 
#       border-color: #03045e; 
#     }
#     
#     .card-titulo { 
#       color: #03045e; 
#       font-size: 15px; 
#       font-weight: 700; 
#       margin-bottom: 10px; 
#       letter-spacing: 0.5px;
#       text-transform: uppercase;
#     }
#     
#     .card-desc { 
#       color: #666; 
#       font-size: 12px; 
#       min-height: 40px; 
#       margin-bottom: 20px; 
#       line-height: 1.5; 
#     }
#     
#     .btn-container { 
#       display: flex; 
#       gap: 10px; 
#     }
#     
#     .btn-alex { 
#       flex: 1; 
#       text-align: center; 
#       padding: 9px 5px; 
#       text-decoration: none; 
#       font-size: 11px; 
#       font-weight: 600; 
#       border-radius: 4px; 
#       transition: 0.2s;
#       border: 1px solid transparent;
#     }
#     
#     /* Botão Acessar: Azul Sóbrio */
#     .btn-acesso { 
#       background-color: #03045e; 
#       color: white; 
#     }
#     .btn-acesso:hover { 
#       background-color: #000835; 
#       box-shadow: 0 2px 5px rgba(0,0,0,0.2);
#     }
#     
#     /* Botão Download: Outline Cinza Profissional */
#     .btn-down { 
#       background-color: #f8f9fa; 
#       color: #333; 
#       border: 1px solid #ccc;
#     }
#     .btn-down:hover { 
#       background-color: #333; 
#       color: white; 
#       border-color: #333;
#     }
#   "))
# 
#   lista_cards <- base::apply(df, 1, function(x) {
#     url_download <- base::gsub("/edit.*", "/export?format=xlsx", x['url'])
#     
#     htmltools::tags$div(class = "card-alex",
#       htmltools::tags$div(
#         htmltools::tags$div(class = "card-titulo", x['titulo']),
#         htmltools::tags$div(class = "card-desc", x['descricao'])
#       ),
#       htmltools::tags$div(class = "btn-container",
#         htmltools::tags$a(href = x['url'], target = "_blank", class = "btn-alex btn-acesso", "ACESSAR"),
#         htmltools::tags$a(href = url_download, target = "_blank", class = "btn-alex btn-down", "DOWNLOAD")
#       )
#     )
#   })
# 
#   htmltools::tagList(estilo_css, htmltools::tags$div(class = "container-cards", lista_cards))
# }
# 
# # 3. EXIBIR A CENTRAL
# gerar_central_cards(dados_cards)

# ==========================================================
# CENTRAL DE DOWNLOADS E ACESSO - VERSÃO ATUALIZADA ALEX
# ==========================================================

# 1. Criação do DataFrame (Mantido conforme original)
bd_central_downloads <- base::data.frame(
  "id_planilha" = base::c("Processos", "Itens", "Natureza da Despesa", "Fonte de Recurso", "Elemento de Despesa", "Catálogo e-Compras"),
  "descricao"   = base::c("Cabeçalho da Operação (Datas, Setores, Agentes)", "Detalhamento Financeiro vinculado aos processos", "Dicionário para tradução de códigos contábeis", "Identificação da origem do capital", "Classificação detalhada do objeto de gasto", "Tabela mestra de padronização de itens do Estado"),
  "url"         = base::c(
    "https://docs.google.com/spreadsheets/d/1UAgVUdYJmIwt0DHRX7mNhkZKpR4nPGyeiUqHirggZ2I/edit?gid=1061612826",
    "https://docs.google.com/spreadsheets/d/1UAgVUdYJmIwt0DHRX7mNhkZKpR4nPGyeiUqHirggZ2I/edit?gid=1088782695",
    "https://docs.google.com/spreadsheets/d/1dLUIAM6rL0B5VIftJr3g75L3nOr00KUIJzJzMOON6dg/edit?gid=1685660687",
    "https://docs.google.com/spreadsheets/d/1hsBIixCr7wpQqCdl9f43vIAO-dj2G4f6c_wTbuntJMQ/edit?gid=1283626696",
    "https://docs.google.com/spreadsheets/d/17OYfesFjT0emcNoZOEyzXuKHm1Ltfv7DMCZdkuX6yOI/edit?gid=323608856",
    "https://docs.google.com/spreadsheets/d/1Ywc-hhVPs5lRvmRMe0xKbSQyuca7WmecfRzzScUr7mk/edit?gid=1899552131"
  ),
  stringsAsFactors = FALSE
)

# 2. Geração dos Botões HTML (Acessar e Download)
bd_central_downloads$acessar <- base::apply(bd_central_downloads, 1, function(x) {
  base::paste0("<a href='", x['url'], "' target='_blank' style='background-color:#03045e; color:white; padding:5px 12px; text-decoration:none; border-radius:4px; font-weight:bold; font-size:10px; display:inline-block;'>ACESSAR</a>")
})

bd_central_downloads$download <- base::apply(bd_central_downloads, 1, function(x) {
  url_download <- base::gsub("/edit.*", "/export?format=xlsx", x['url'])
  base::paste0("<a href='", url_download, "' target='_blank' style='background-color:#333333; color:white; padding:5px 12px; text-decoration:none; border-radius:4px; font-weight:bold; font-size:10px; display:inline-block;'>DOWNLOAD</a>")
})

# 3. Configurações de Exibição (VETORES)
minhas_colunas_down <- base::c(
  "Banco de Dados"  = "id_planilha",
  "Descrição"       = "descricao",
  "Acesso<br>Online" = "acessar",   # Usando <br> para testar a nova função
  "Baixar<br>Arquivo" = "download"  # Usando <br> para testar a nova função
)

# Larguras: Banco de dados com maior espaço (dominante)
minhas_larguras_down <- base::c("800px", "350px", "90px", "90px")

# Alinhamentos: Banco e Descrição Justificados | Botões Centralizados
meu_alin_header_down <- base::c("left", "left", "center", "center")
meu_alin_corpo_down  <- base::c("justify", "justify", "center", "center")

# 4. Execução da Renderização
tabela_interativa(
  dados                = bd_central_downloads,
  titulo_tabela        = "Central de Downloads e Repositório de Dados",
  tam_fonte_corpo      = "11.3px",
  tam_fonte_header     = "12.2px",
  tam_fonte_titulo     = "14.3px",
  cor_titulo           = "#03045e",
  cor_primaria         = "#03045e",
  cor_texto_corpo      = "#000000",
  mostrar_filtro       = FALSE,
  pesquisa_geral       = FALSE,
  largura_cols_vetor   = minhas_larguras_down,
  colunas_selecionadas = minhas_colunas_down,
  # Novos parâmetros de alinhamento:
  alinhamento_header_vetor = meu_alin_header_down,
  alinhamento_corpo_vetor  = meu_alin_corpo_down,
  n_pages = 6,
  mostrar_indice = FALSE
)

# ==========================================================
# CENTRAL DE DOWNLOADS E ACESSO - VERSÃO INTEGRAL COMENTADA
# ==========================================================

# # Inicia a criação do dataframe com os dados, descrições e links originais Alex
# bd_central_downloads <- base::data.frame(
#   # Define o nome amigável de cada banco de dados
#   "id_planilha" = base::c("Processos", "Itens", "Natureza da Despesa", "Fonte de Recurso", "Elemento de Despesa", "Catálogo e-Compras"),
#   # Define a descrição técnica de cada base
#   "descricao"   = base::c("Cabeçalho da Operação (Datas, Setores, Agentes)", "Detalhamento Financeiro vinculado aos processos", "Dicionário para tradução de códigos contábeis", "Identificação da origem do capital", "Classificação detalhada do objeto de gasto", "Tabela mestra de padronização de itens do Estado"),
#   # Define as URLs reais das planilhas que você enviou
#   "url"         = base::c(
#     "https://docs.google.com/spreadsheets/d/1UAgVUdYJmIwt0DHRX7mNhkZKpR4nPGyeiUqHirggZ2I/edit?gid=1061612826", # Link Processos
#     "https://docs.google.com/spreadsheets/d/1UAgVUdYJmIwt0DHRX7mNhkZKpR4nPGyeiUqHirggZ2I/edit?gid=1088782695", # Link Itens
#     "https://docs.google.com/spreadsheets/d/1dLUIAM6rL0B5VIftJr3g75L3nOr00KUIJzJzMOON6dg/edit?gid=1685660687", # Link Natureza
#     "https://docs.google.com/spreadsheets/d/1hsBIixCr7wpQqCdl9f43vIAO-dj2G4f6c_wTbuntJMQ/edit?gid=1283626696", # Link Fonte
#     "https://docs.google.com/spreadsheets/d/17OYfesFjT0emcNoZOEyzXuKHm1Ltfv7DMCZdkuX6yOI/edit?gid=323608856", # Link Elemento
#     "https://docs.google.com/spreadsheets/d/1Ywc-hhVPs5lRvmRMe0xKbSQyuca7WmecfRzzScUr7mk/edit?gid=1899552131"  # Link Catálogo
#   ),
#   # Garante que as strings não virem fatores
#   stringsAsFactors = FALSE
# )
# 
# # --- GERAÇÃO DO BOTÃO ACESSAR (ABRE A PLANILHA NO NAVEGADOR) ---
# bd_central_downloads$acessar <- base::apply(bd_central_downloads, 1, function(x) {
#   # Retorna link HTML estilizado na cor azul marinho oficial Alex
#   base::paste0("<a href='", x['url'], "' target='_blank' style='background-color:#03045e; color:white; padding:5px 12px; text-decoration:none; border-radius:4px; font-weight:bold; font-size:10px; display:inline-block;'>ACESSAR</a>")
# })
# 
# # --- GERAÇÃO DO BOTÃO DOWNLOAD (BAIXA O EXCEL AUTOMATICAMENTE) ---
# bd_central_downloads$download <- base::apply(bd_central_downloads, 1, function(x) {
#   # Transforma o link de edição em link de exportação direta para Excel (.xlsx)
#   url_download <- base::gsub("/edit.*", "/export?format=xlsx", x['url'])
#   # Retorna link HTML com cor preta para diferenciar do botão de acesso
#   base::paste0("<a href='", url_download, "' target='_blank' style='background-color:#333333; color:white; padding:5px 12px; text-decoration:none; border-radius:4px; font-weight:bold; font-size:10px; display:inline-block;'>DOWNLOAD</a>")
# })
# 
# # Define os vetores de mapeamento para as colunas que você quer exibir
# minhas_colunas_down <- base::c(
#   "Banco de Dados" = "id_planilha",
#   "Descrição"      = "descricao",
#   "Acesso Online"  = "acessar",
#   "Baixar Arquivo" = "download"
# )
# 
# # Define larguras fixas para acomodar os dois botões lateralmente
# minhas_larguras_down <- base::c("800px", "200px", "80px", "80px")
# 
# # Executa a renderização da tabela com seus padrões de fonte e cores
# tabela_interativa(
#   # Passa o dataframe com as duas colunas de botões criadas
#   dados = bd_central_downloads,
#   # Define o título do repositório
#   titulo_tabela = "Central de Downloads e Repositório de Dados",
#   # Aplica suas fontes compactas Alex
#   tam_fonte_corpo  = "11.3px",
#   tam_fonte_header = "12.2px",
#   tam_fonte_titulo = "14.3px",
#   # Aplica suas cores oficiais
#   cor_titulo       = "#03045e",
#   cor_primaria     = "#000000",
#   cor_texto_corpo  = "#000000",
#   # Mantém visual limpo sem filtros individuais
#   mostrar_filtro   = FALSE,
#   # Mantém busca global ativa na ESQUERDA
#   pesquisa_geral   = FALSE,
#   # Aplica vetores de configuração definidos acima
#   largura_cols_vetor   = minhas_larguras_down,
#   colunas_selecionadas = minhas_colunas_down,
#   # Mostra 6 linhas por página e oculta o índice lateral
#   n_pages = 6,
#   mostrar_indice = FALSE
# )
```


<!-- Reestruturação e tratamento dos dados -->

```{r}
#| label: Reestruturação e tratamento dos dados
#| code-summary: "Reestruturação e tratamento dos dados"

# --- 4. EXECUÇÃO DO TRATAMENTO ---

# 4.1. Tratamento da Base de Processos (Integridade de Chaves e Datas)
bd_processos <- bd_processos %>% 
  dplyr::mutate(
    agente              = padronizar.categorias.nominais(agente),                  # Agente (Title Case)
    processo            = stringr::str_pad(base::as.character(stringr::str_trim(processo)), 
                                           width = 14, side = "left", pad = "0"),  # Chave: 14 digitos
    modalidade_processo = padronizar.categorias.nominais(modalidade_processo, caixa_alta = TRUE), # Modalidade (UPPER)
    data_de_entrada     = padronizar.data(data_de_entrada),                        # Data Entrada
    data_de_saida       = padronizar.data(data_de_saida),                          # Data Saida
    natureza_despesa    = stringr::str_pad(padronizar.categorias.nominais(natureza_despesa, caixa_alta = TRUE), 
                                           width = 10, side = "left", pad = "0"),  # Natureza: 10 digitos
    setor               = padronizar.categorias.nominais(setor)                    # Setor (Title Case)
  )



# 4.2. Tratamento da Base de Itens (Conversão Financeira e IDs)
bd_itens <- bd_itens %>% 
  dplyr::mutate(
    processo        = stringr::str_pad(base::as.character(stringr::str_trim(processo)), 
                                       width = 14, side = "left", pad = "0"),      # Chave p/ Join
    id              = base::as.numeric(id),                                        # ID p/ Catálogo
    fornecedor      = padronizar.categorias.nominais(fornecedor),                  # Fornecedor (Title Case)
    qtde            = base::as.numeric(qtde),                                      # Qtd Numérica
    valor_unitario  = as.numeric(valor_unitario),                          # Valor Limpo
    nota_de_empenho = base::as.character(stringr::str_trim(nota_de_empenho)),      # Nota (Texto)
    data_empenho    = base::as.character(stringr::str_trim(data_empenho))          # Data (Texto)
  )


# ------------------------------------------------------------------------------
# 5.1. CONSOLIDAÇÃO TOTAL E GERAÇÃO DE KPIS
# ------------------------------------------------------------------------------

bd_principal <- dplyr::left_join(
  bd_itens, 
  bd_processos, 
  by     = "processo", 
  suffix = base::c("_item", "_proc")
) %>% 
  dplyr::mutate(
    # --- TRATAMENTO DE DATAS ---
    data_de_entrada = lubridate::as_date(data_de_entrada),
    data_de_saida   = lubridate::as_date(data_de_saida),
    
    # --- KPIS TEMPORAIS ---
    ano             = lubridate::year(data_de_entrada),
    mes_entrada     = lubridate::month(data_de_entrada, label = TRUE, abbr = FALSE),
    mes_saida       = lubridate::month(data_de_saida, label = TRUE, abbr = FALSE)
  ) %>% 
  
  # --- CÁLCULO DE DIAS ÚTEIS (LINHA POR LINHA) ---
  dplyr::rowwise() %>% 
  dplyr::mutate(
    dias_uteis = calcular_dias_uteis_alex(data_de_entrada, data_de_saida)
  ) %>% 
  dplyr::ungroup() %>% 
  
  # --- DEMAIS VARIÁVEIS DE INTELIGÊNCIA ---
  dplyr::mutate(
    # Status Financeiro
    status_item      = dplyr::if_else(!base::is.na(nota_de_empenho) & nota_de_empenho != "", 
                                      "EMPENHADO", "NÃO EMPENHADO"),
    valor_total      = base::round(qtde * valor_unitario, 3)
    ) %>% 
  
  # --- MÉTRICAS AGRUPADAS POR PROCESSO ---
  dplyr::group_by(processo) %>% 
  dplyr::mutate(
    qtd_itens_processo = dplyr::n(),
    pct_empenho        = base::round((base::sum(status_item == "EMPENHADO") / dplyr::n()) * 100, 2)
  ) %>% 
  dplyr::ungroup()


bd_principal <- bd_principal %>% 
  
  # 7.1. Detalhamento do ID (Catálogo e-Compras)
  dplyr::left_join(
    bd_catalogo %>% dplyr::select(id, catalogo_descricao = descricao, grupo, subgrupo,  elemento = elemento),
    by = "id"
  ) %>% 
  
  # 7.2. Detalhamento da Fonte de Recurso
  dplyr::left_join(
    bd_fonte %>% dplyr::select(fonte, fonte_desc = descricao, fonte_tipo = tipo),
    by = base::c("fonte_recurso" = "fonte")
  ) %>% 
  
  # 7.3. Detalhamento da Natureza da Despesa
  dplyr::left_join(
    bd_natureza %>% dplyr::select(cod, nd_especificacao = especificacao),
    by = base::c("natureza_despesa" = "cod")
  ) 

# ------------------------------------------------------------------------------
# 8. ORGANIZAÇÃO FINAL DAS COLUNAS (O RELATÓRIO DO ALEX)
# ------------------------------------------------------------------------------

bd_principal <- bd_principal %>% 
  dplyr::select(
    # Gestão e Cabeçalho
    processo, modalidade_processo, agente, setor, emenda, qtd_itens_processo,                
    
    # Detalhes do Produto e Classificação de Compra
    elemento, id, catalogo_descricao, grupo, subgrupo, fornecedor,  

    # Dados Financeiros e de Empenho
    qtde, valor_unitario, valor_total, 
    nota_de_empenho, data_empenho, status_item,           
    
    # Contabilidade Pública
    natureza_despesa, nd_especificacao,                   
    fonte_recurso, fonte_desc, fonte_tipo,                
    
    # KPIs e Inteligência de Tempo
    dias_uteis, ano, data_de_entrada, data_de_saida, mes_entrada, mes_saida, pct_empenho  
  )

```


:::



## Gestão de Fluxos e Indicadores 

<!-- grafico - Entrada e saida de processos -->

::: {style="font-size: 0.9em; text-align: justify; margin-top: 25px; margin-bottom: 25px; "}


```{r}
#| label: Entrada e saida processos
#| code-summary: "Entrada e saida processos"
#| echo: false
#| warning: false
#| message: false
#| out-width: "100%"
#| fig-height: 7

# Define o título principal que identifica a subgerência e o ano
titulo_nome        <- "Gráfico 1: Fluxo Operacional de Processos"
# titulo_nome        <- "Gráfico 1: Fluxo Operacional de Processos | Subgerência de - Compras 2025"
# Define o texto do subtítulo descritivo do fluxo
# subtitulo_texto    <- "Comparativo Mensal de Entradas e Saídas"
subtitulo_texto    <- ""


# Configuração de cor e tamanho para o título principal (Azul Escuro)
titulo_cor         <- "#03045e"
titulo_tamanho     <- 14.5
# Configuração de cor e tamanho para o subtítulo (Preto)
sub_cor            <- "#000000"
sub_tamanho        <- 13         

# Definição das cores das barras para Entradas e Saídas (Padrão Alex)
cor_entradas       <- "#001d3d"  # Azul Marinho Profundo
cor_saidas         <- "#48cae4"  # Azul Celeste Claro

# Configurações de tamanho e cor para os rótulos de valores nas pontas das barras
tamanho_rotulos    <- 10         
cor_rotulos        <- "#000000"
# Configurações de tamanho e cor para o texto do eixo X (meses)
tamanho_eixo_x     <- 11         
cor_eixo_x         <- "#000000"

# Configurações de interatividade para legenda e botões do gráfico
tamanho_legenda    <- 12         
cor_legenda        <- "#000000"
tamanho_botoes     <- 12         

# Estilo visual do balão de hover (Fundo branco com borda preta)
hover_bg_cor       <- "#FFFFFF"  # Fundo branco
hover_txt_cor      <- "#000000"  # Texto preto
hover_fonte_tam    <- 12         # Tamanho da fonte interna
borda_balao_hover  <- "#000000"  # Cor da borda do balão
alinhamento_balao_hover <- "left" # Texto alinhado à esquerda

# ==========================================================
# --- 1. PREPARAÇÃO DOS DADOS ---
# ==========================================================

# Vetor para garantir a ordem cronológica dos meses no gráfico
meses_ordem_limpo <- base::c("Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", 
                             "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro")

# Dicionário de tradução dos meses de Inglês para Português
tradutor_meses <- base::c(
  "January" = "Janeiro", "February" = "Fevereiro", "March" = "Março", 
  "April" = "Abril", "May" = "Maio", "June" = "Junho", 
  "July" = "Julho", "August" = "Agosto", "September" = "Setembro", 
  "October" = "Outubro", "November" = "Novembro", "December" = "Dezembro"
)

# Início do tratamento da base de dados principal (bd_principal)
dados_base_limpa <- bd_principal %>%
  # Remove duplicatas para garantir contagem única por processo
  dplyr::distinct(processo, .keep_all = TRUE) %>%
  # Seleciona apenas as colunas essenciais para o gráfico e o hover
  dplyr::select(processo, mes_entrada, mes_saida, modalidade_processo, status_item) %>%
  # Transforma colunas de entrada/saída em linhas (Correção: uso de all_of para nomes de colunas)
  tidyr::pivot_longer(cols = dplyr::all_of(base::c("mes_entrada", "mes_saida")), 
                      names_to = "Origem", 
                      values_to = "Mes_Nome") %>%
  # Cria coluna de Tipo para separar Entradas de Saídas
  dplyr::mutate(Tipo = dplyr::if_else(Origem == "mes_entrada", "Entradas", "Saídas")) %>%
  # Filtra registros com meses válidos
  dplyr::filter(!base::is.na(Mes_Nome)) %>%
  # Traduz o nome do mês e cria o fator ordenado com a tag HTML de negrito
  dplyr::mutate(
    Mes_Nome_Limpo = dplyr::recode(Mes_Nome, !!!tradutor_meses),
    Mes_Bold = base::factor(base::paste0("<b>", Mes_Nome_Limpo, "</b>"), 
                            levels = base::paste0("<b>", meses_ordem_limpo, "</b>"))
  )

# Cria esqueleto completo para garantir que todos os meses apareçam, mesmo com valor zero
esqueleto <- base::expand.grid(
  Mes_Bold = base::factor(base::paste0("<b>", meses_ordem_limpo, "</b>"), 
                          levels = base::paste0("<b>", meses_ordem_limpo, "</b>")), 
  Tipo = base::c("Entradas", "Saídas"), 
  stringsAsFactors = FALSE
)

# Função para processar dados com a regra de Hover Condicional solicitada
gerar_dados_seguros <- function(df, mod = NULL) {
  # Filtra por modalidade específica se não for a opção "Todas"
  df_f <- df
  if (!base::is.null(mod) && mod != "Todas as Modalidades") { 
    df_f <- df_f %>% dplyr::filter(modalidade_processo == mod) 
  }
  
  # Consolida contagens e define o Hover inicial
  df_res <- df_f %>%
    dplyr::group_by(Mes_Bold, Tipo) %>%
    dplyr::summarise(
      Quantidade = dplyr::n(),
      # Correção: Uso de dplyr::if_else para processar a lógica do Hover sem erro de sintaxe
      Hover = dplyr::if_else(
        base::is.null(mod) || mod == "Todas as Modalidades",
        "Resumo Geral", 
        base::paste0("<b>Processos:</b><br>", base::paste(base::unique(base::paste0("• ", processo)), collapse = "<br>"))
      ),
      .groups = "drop"
    ) %>%
    # Join com esqueleto para preencher meses vazios no gráfico
    dplyr::right_join(esqueleto, by = base::c("Mes_Bold", "Tipo")) %>%
    # Trata valores NA resultantes do Join
    dplyr::mutate(
      Quantidade = base::ifelse(base::is.na(Quantidade), 0, Quantidade), 
      Hover = base::ifelse(base::is.na(Hover), "Sem processos registrados", Hover)
    ) %>%
    # Ordena cronologicamente para a renderização do Plotly
    dplyr::arrange(Tipo, Mes_Bold)
  
  # Bloco para preencher o "Resumo Geral" no Hover quando selecionado "Todas as Modalidades"
  if (base::is.null(mod) || mod == "Todas as Modalidades") {
    hover_todas <- df_f %>%
      dplyr::group_by(Mes_Bold, Tipo, modalidade_processo) %>%
      dplyr::summarise(n = dplyr::n(), .groups = "drop") %>%
      dplyr::group_by(Mes_Bold, Tipo) %>%
      dplyr::mutate(total = base::sum(n)) %>%
      dplyr::summarise(
        Hover_Full = base::paste(base::paste0("• ", modalidade_processo, ": ", n, " (", base::round((n/total)*100,1), "%)"), collapse = "<br>"),
        .groups = "drop"
      )
    # Atualiza o dataframe de resultados com o texto de hover detalhado
    df_res <- df_res %>%
      dplyr::left_join(hover_todas, by = base::c("Mes_Bold", "Tipo")) %>%
      dplyr::mutate(Hover = base::ifelse(!base::is.na(Hover_Full), Hover_Full, Hover)) %>%
      dplyr::select(-Hover_Full)
  }
  
  return(df_res)
}

# Função para montar os botões de modalidade de forma dinâmica
montar_botoes <- function(lista) {
  base::lapply(lista, function(v) {
    # Recalcula dados e hover específico para a modalidade do botão
    d <- gerar_dados_seguros(dados_base_limpa, mod = v)
    de <- d %>% dplyr::filter(Tipo == "Entradas"); ds <- d %>% dplyr::filter(Tipo == "Saídas")
    t_e <- base::sum(de$Quantidade); t_s <- base::sum(ds$Quantidade)
    # Retorna lista de argumentos de atualização para o Plotly
    base::list(method = "update", label = v,
               args = base::list(base::list(y = base::list(de$Quantidade, ds$Quantidade),
                                            text = base::list(base::paste0("<b>", de$Quantidade, "</b>"), base::paste0("<b>", ds$Quantidade, "</b>")),
                                            hovertext = base::list(de$Hover, ds$Hover),
                                            name = base::list(base::paste0("<b>Entradas (Total: ", t_e, ")</b>"), 
                                                              base::paste0("<b>Saídas (Total: ", t_s, ")</b>")))))
  })
}

# Gera a lista de modalidades única para alimentar o dropdown do gráfico
lista_m <- base::c("Todas as Modalidades", base::sort(base::as.character(base::unique(dados_base_limpa$modalidade_processo))))

# Define os dados iniciais do primeiro render do gráfico
df_i <- gerar_dados_seguros(dados_base_limpa)
df_e_ini <- df_i %>% dplyr::filter(Tipo == "Entradas") 
df_s_ini <- df_i %>% dplyr::filter(Tipo == "Saídas") 

# ==========================================================
# --- 4. GRÁFICO FINAL (PLOTLY) ---
# ==========================================================

plotly::plot_ly() %>%
  # Adiciona a série de Entradas (Barras Escuras)
  plotly::add_bars(x = df_e_ini$Mes_Bold, y = df_e_ini$Quantidade, 
                   name = base::paste0("<b>Entradas (Total: ", base::sum(df_e_ini$Quantidade), ")</b>"),
                   marker = base::list(color = cor_entradas),
                   text = base::paste0("<b>", df_e_ini$Quantidade, "</b>"),
                   textposition = 'outside', cliponaxis = FALSE,
                   textfont = base::list(family = "Inter, sans-serif", size = tamanho_rotulos, color = cor_rotulos),
                   hoverinfo = "text", hovertext = df_e_ini$Hover) %>%
  # Adiciona a série de Saídas (Barras Claras)
  plotly::add_bars(x = df_s_ini$Mes_Bold, y = df_s_ini$Quantidade, 
                   name = base::paste0("<b>Saídas (Total: ", base::sum(df_s_ini$Quantidade), ")</b>"),
                   marker = base::list(color = cor_saidas),
                   text = base::paste0("<b>", df_s_ini$Quantidade, "</b>"),
                   textposition = 'outside', cliponaxis = FALSE,
                   textfont = base::list(family = "Inter, sans-serif", size = tamanho_rotulos, color = cor_rotulos),
                   hoverinfo = "text", hovertext = df_s_ini$Hover) %>%
  # Define o Layout, Estilos de Hover, Eixos e Menus Dropdown
  plotly::layout(
    font = base::list(family = "Inter, sans-serif"),
    # Configura Título e Subtítulo com as variáveis de cor e tamanho do Alex
    title = base::list(
      text = base::paste0("<b style='color:", titulo_cor, "; font-size:", titulo_tamanho, "px'>", titulo_nome, "</b>",
                          "<br><span style='color:", sub_cor, "; font-size:", sub_tamanho, "px'>", subtitulo_texto, "</span>"),
      x = 0, y = 0.98, xanchor = "left", xref = "paper"
    ),
    # Aplica o estilo do Hover Label definido pelo Alex
    hoverlabel = base::list(
      bgcolor = hover_bg_cor,
      font = base::list(family = "Inter, sans-serif", size = hover_fonte_tam, color = hover_txt_cor),
      bordercolor = borda_balao_hover,
      align = alinhamento_balao_hover
    ),
    # Configura o Eixo X com os nomes dos meses em negrito
    xaxis = base::list(
      title = "",
      showgrid = FALSE, 
      tickfont = base::list(family = "Inter, sans-serif", size = tamanho_eixo_x, color = cor_eixo_x),
      fixedrange = TRUE
    ),
    # Configura o Eixo Y ocultando os números e definindo o intervalo de visualização
    yaxis = base::list(title = "", 
                       showticklabels = FALSE, 
                       showgrid = TRUE, 
                       gridcolor = "#F0F0F0", 
                       range = base::list(0, base::max(df_i$Quantidade) * 1.5)),
    barmode = 'group', # Define barras lado a lado
    bargap = 0.2,      # Distância entre grupos mensais
    bargroupgap = 0.1, # Distância entre barras internas do mês
    # Menus de botões (Updatemenus)
    updatemenus = base::list(
      # Menu de Modalidades (Dropdown na posição esquerda 0)
      base::list(active = 0, x = 0, y = 1.13, xanchor = "left", 
                 buttons = montar_botoes(lista_m),
                 font = base::list(family = "Inter, sans-serif", size = tamanho_botoes)),
      # Menu de Tipo de Gráfico (Dropdown na posição 0.30)
      base::list(active = 0, x = 0.20, y = 1.13, xanchor = "left",
                 buttons = base::list(
                   base::list(method = "update", label = "Gráfico: Barras", 
                              args = base::list(base::list(type = "bar", textposition = "outside"), 
                                                base::list(margin = base::list(t = 130, b = 120, l = 0, r = 0)))),
                   base::list(method = "update", label = "Gráfico: Linhas", 
                              args = base::list(base::list(type = "scatter", mode = "lines+markers+text", textposition = "top center"),
                                                base::list(margin = base::list(t = 130, b = 120, l = 0, r = 0))))
                 ), font = base::list(family = "Inter, sans-serif", size = tamanho_botoes))
    ),
    # Legenda superior horizontal configurada pelo Alex
    legend = base::list(orientation = 'h', x = 0, xanchor = "left", y = 1.25,
                        font = base::list(family = "Inter, sans-serif", size = tamanho_legenda, color = cor_legenda)),
    # Ajuste fino das margens do gráfico
    margin = base::list(t = 130, b = 120, l = 0, r = 0),
    plot_bgcolor = "white", paper_bgcolor = "white"
  ) %>%
  # Configuração de responsividade e ocultação da barra do Plotly
  plotly::config(displayModeBar = FALSE, responsive = TRUE)



# ==========================================================
# CONFIGURAÇÃO DE FONTES E CORES (VISUAL COMPACTO ALEX)
# ==========================================================
tam_fonte_corpo = "11.3px"
tam_fonte_titulo = "14.3px"
tam_fonte_header = "12.2px"
cor_titulo = "#03045e"
cor_primaria = "#000000"
cor_texto_corpo = "#000000"

# ==========================================================
# --- 1. PREPARAÇÃO DA TABELA PRINCIPAL (RESUMO POR PROCESSO) ---
# ==========================================================

# Vetor auxiliar para tradução (Trata os nomes que o GitHub gera)
traducao_meses <- c(
  "January" = "Janeiro", "February" = "Fevereiro", "March" = "Março",
  "April" = "Abril", "May" = "Maio", "June" = "Junho",
  "July" = "Julho", "August" = "Agosto", "September" = "Setembro",
  "October" = "Outubro", "November" = "Novembro", "December" = "Dezembro"
)

bd_resumo_processos <- bd_principal %>%
  dplyr::group_by(processo) %>% 
  dplyr::summarise(
    modalidade   = dplyr::first(modalidade_processo),
    agente       = dplyr::first(agente),
    total_itens  = base::max(qtd_itens_processo, na.rm = TRUE),
    v_total_num  = base::sum(valor_total, na.rm = TRUE),
    dias_uteis   = base::max(dias_uteis, na.rm = TRUE),
    
    # Pegamos os meses originais
    mes_entrada_raw = dplyr::first(mes_entrada),
    mes_saida_raw   = dplyr::last(base::sort(mes_saida)),
    
    pct_empenho  = base::mean(pct_empenho, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  dplyr::mutate(
    # --- AQUI ESTÁ A TRADUÇÃO ---
    mes_entrada = dplyr::recode(mes_entrada_raw, !!!traducao_meses),
    mes_saida   = dplyr::recode(mes_saida_raw, !!!traducao_meses),
    
    valor_total_proc = base::paste0("R$ ", base::format(v_total_num, big.mark = ".", decimal.mark = ",")),
    pct_empenho      = base::paste0(base::round(pct_empenho, 1), "%")
  )

# ==========================================================
# --- 2. PREPARAÇÃO DA TABELA DE DETALHES (ITENS DO PROCESSO) ---
# ==========================================================

bd_detalhes_itens <- bd_principal %>%
  dplyr::mutate(
    v_unit_txt  = base::paste0("R$ ", base::format(valor_unitario, big.mark = ".", decimal.mark = ",")),
    v_total_txt = base::paste0("R$ ", base::format(valor_total, big.mark = ".", decimal.mark = ","))
  ) %>%
  dplyr::select(
    processo, 
    id, 
    catalogo_descricao, 
    fornecedor, 
    qtde, 
    v_unit_txt, 
    v_total_txt,
    status_item,
    dias_uteis # Adicionado dias úteis por item conforme solicitado
  )

# ==========================================================
# 3. VETORES DE CONFIGURAÇÃO (NOMES E LARGURAS)
# ==========================================================

# --- TABELA PRINCIPAL (PAI) ---
minhas_colunas <- base::c(
  "Nº Processo"       = "processo",
  "Modalidade"        = "modalidade",
  "Agente"            = "agente",
  "Qtd. Itens"        = "total_itens",
  "Mês<br>(Entrada)"       = "mes_entrada",
  "Mês<br>(Saída)"         = "mes_saida",
  "Valor Total (R$)"  = "valor_total_proc",
  "Tempo<br>(Dias)"      = "dias_uteis",
  "(%) Empenho"       = "pct_empenho"
)

minhas_larguras <- base::c("30px", 
                           "130px", 
                           "100px", 
                           "140",
                           "60px", 
                           "60px", 
                           "60px", 
                           "270px", 
                           "80px", 
                           "70px")

alinhamento_1 <- c("center","center","center",
                   "center","center","center",
                   "center","center","center")

# --- SUB-TABELA DE DETALHES (FILHA) ---
# Adicionado "Tempo Item" ao final do vetor
meus_nomes_detalhes <- base::c(
  "ID Item", 
  "Descrição Material / Serviço", 
  "Fornecedor", 
  "Qtd",
  "Valor Unitário", 
  "Valor Total",
  "Situação",
  "Tempo (Dias)"
)

alinhamento_1 <- c("center","justify","center",
                   "center","center","center",
                   "center","center")

# Ajuste nas larguras dos detalhes para acomodar a nova coluna
minhas_larguras_detalhes <- base::c("60px", 
                                    "400px", 
                                    "210px", 
                                    "60px", 
                                    "130px", 
                                    "130px", 
                                    "120px", 
                                    "70px")

# ==========================================================
# 4. EXECUÇÃO DO RELATÓRIO
# ==========================================================

tabela_interativa_detalhes(
  dados                  = bd_resumo_processos,
  dados_detalhes          = bd_detalhes_itens,
  coluna_chave           = "processo",
  titulo_tabela          = "Detalhamento dos Processos",
  
  tam_fonte_corpo        = tam_fonte_corpo,
  tam_fonte_header       = tam_fonte_header,
  tam_fonte_titulo       = tam_fonte_titulo,
  cor_titulo             = cor_titulo,
  cor_primaria           = cor_primaria,
  cor_texto_corpo        = cor_texto_corpo,
  
  colunas_selecionadas   = minhas_colunas,
  largura_cols_vetor      = minhas_larguras,
  colunas_detalhes_nomes = meus_nomes_detalhes,
  largura_detalhes_vetor = minhas_larguras_detalhes,
  alinhamento_header_vetor = alinhamento_1,
  alinhamento_corpo_vetor = alinhamento_2,
  
  
  mostrar_filtro          = FALSE,
  pesquisa_geral          = TRUE, 
  n_pages                = 10,
  mostrar_indice          = FALSE
)

```

:::

### Índices de Produtividade 

::: {style="font-size: 0.9em; text-align: justify; margin-top: 25px; margin-bottom: 25px; "}

::: {.panel-tabset}

## Setor

```{r}
# ==========================================================
# FUNÇÃO SETORIAL - VERSÃO FINAL COM HOVER ORGANIZADO
# ==========================================================
gerar_dashboard_setor <- function(bd_principal,
                                  # Tamanhos do Centro
                                  tam_titulo_graf  = 20,
                                  tam_centro_cab   = 12,
                                  tam_centro_dest  = 10,
                                  tam_centro_corpo = 10,
                                  # Tamanhos do Hover (Baloes)
                                  tam_hover_header = 14,
                                  tam_hover_dest   = 14,
                                  tam_hover_corpo  = 12,
                                  # Fatias e Cores
                                  tam_fatias       = 11,
                                  cor_eficiencia   = "#0b132b",
                                  cor_titulo       = "#081c15") {
  
  # --- BLOCO DE CONFIGURAÇÃO INTERNO ---
  fonte_padrao    <- "Inter, sans-serif"
  cores_fatias    <- c('#74c69d', '#40916c', '#6fffe9', '#5bc0be', '#3a506b', '#1c2541', '#0b132b', '#081c15', '#000000')
  cor_empenhado   <- "#008000"
  cor_pendente    <- "#B22222"
  espacador_frase <- "<span style='font-size:4px;'><br></span>"
  espacador_bloco <- "<span style='font-size:10px;'><br></span>"
  
  # --- 1. PROCESSAMENTO ---
  df_proc_unico <- bd_principal %>%
    dplyr::group_by(processo) %>%
    dplyr::summarise(
      modalidade       = dplyr::first(modalidade_processo),
      tempo_processo   = base::max(dias_uteis, na.rm = TRUE),
      valor_processo   = base::sum(valor_total, na.rm = TRUE),
      total_itens_proc = dplyr::n(),
      itens_empenhados = base::sum(status_item == "Empenhado" | !base::is.na(nota_de_empenho), na.rm = TRUE),
      valor_empenhado  = base::sum(base::ifelse(status_item == "Empenhado" | !base::is.na(nota_de_empenho), valor_total, 0), na.rm = TRUE),
      .groups = "drop"
    ) %>%
    dplyr::mutate(situacao_proc = base::ifelse(itens_empenhados == total_itens_proc, "Resolvido", "Pendente"))
  
  # --- 2. AGRUPAMENTO POR MODALIDADE (HOVER RESTAURADO) ---
  df_modalidade <- df_proc_unico %>%
    dplyr::group_by(modalidade) %>%
    dplyr::summarise(
      n_processos = dplyr::n(), n_resolvidos = base::sum(situacao_proc == "Resolvido"),
      n_pendentes = base::sum(situacao_proc == "Pendente"), valor_total_mod = base::sum(valor_processo),
      valor_emp_mod = base::sum(valor_empenhado), tempo_medio_mod = base::mean(tempo_processo, na.rm = TRUE), .groups = "drop"
    ) %>%
    dplyr::mutate(
      p_res = base::sprintf("%.2f", (n_resolvidos / n_processos) * 100),
      p_pen = base::sprintf("%.2f", (n_pendentes / n_processos) * 100),
      v_total_txt = base::paste0("R$ ", base::format(valor_total_mod, big.mark = ".", decimal.mark = ",")),
      v_emp_txt   = base::paste0("R$ ", base::format(valor_emp_mod, big.mark = ".", decimal.mark = ",")),
      v_pen_txt   = base::paste0("R$ ", base::format(valor_total_mod - valor_emp_mod, big.mark = ".", decimal.mark = ",")),
      
      label_grafico = base::paste0(modalidade, "<br>", n_processos, " proc. (", 
                                   base::sprintf("%.1f", (n_processos / base::sum(n_processos)) * 100), "%)"),
      
      # HOVER ORGANIZADO COM SEÇÕES (RESTAURADO)
      hover_txt = base::paste0("<span style='color:black; font-family:", fonte_padrao, "; font-size:", tam_hover_corpo, "px;'>",
                               "<b style='font-size:", tam_hover_header, "px;'>MODALIDADE: ", modalidade, "</b><br>",
                               "<span style='color:#bdc3c7'>──────────────────────────</span><br>",
                               "<b>PERFORMANCE SETORIAL</b><br>",
                               "<span style='color:", cor_eficiencia, "; font-size:", tam_hover_dest, "px;'>📊 <b>Eficiência: ", p_res, "%</b></span><br>",
                               "⏱ <b>Ciclo Médio:</b> ", base::round(tempo_medio_mod, 0), " dias úteis<br>",
                               "📦 <b>Volume:</b> ", n_processos, " processos totais<br>",
                               "<span style='color:#bdc3c7'>──────────────────────────</span><br>",
                               "<b>STATUS DOS PROCESSOS</b><br>",
                               "• Resolvidos: ", n_resolvidos, " (", p_res, "%)<br>",
                               "• Pendentes: ", n_pendentes, " (", p_pen, "%)<br>",
                               "<span style='color:#bdc3c7'>──────────────────────────</span><br>",
                               "<b>APORTE FINANCEIRO</b><br>",
                               "💰 <b>Total:</b> ", v_total_txt, "<br>",
                               "✅ <b>Empenhado:</b> ", v_emp_txt, "<br>",
                               "❌ <b>Pendente:</b> ", v_pen_txt, "</span>")
    )
  
  # --- 3. MÉTRICAS DO CENTRO ---
  total_p <- base::nrow(df_proc_unico); total_v <- base::sum(df_proc_unico$valor_processo)
  res_n <- base::sum(df_proc_unico$situacao_proc == "Resolvido"); res_v <- base::sum(df_proc_unico$valor_empenhado)
  res_p <- base::sprintf("%.2f", (res_n / total_p) * 100); pen_n <- total_p - res_n
  pen_v <- total_v - res_v; pen_p <- base::sprintf("%.2f", (pen_n / total_p) * 100)
  eficiencia_global <- base::sprintf("%.2f", (res_n / total_p) * 100)
  
  texto_centro <- base::paste0(
    "<span style='font-family:", fonte_padrao, ";'>",
    "<b><span style='color:", cor_titulo, "; font-size:", tam_centro_cab, "px;'>SUMÁRIO CONSOLIDADO SETORIAL</span></b><br>",
    "<span style='color:#bdc3c7'>_________________________________</span><br>",
    espacador_bloco,
    "<b><span style='font-size:", tam_centro_dest, "px;'>Processos Totais: ", total_p, "</span></b><br>",
    espacador_frase,
    "<b><span style='font-size:", tam_centro_dest, "px;'>Valor Total: R$ ", base::format(total_v, big.mark = ".", decimal.mark = ","), "</span></b><br>",
    espacador_frase,
    "<span style='color:", cor_eficiencia, "; font-size:", tam_centro_dest, "px;'>📊 <b>Eficiência Global: ", eficiencia_global, "%</b></span><br>",
    espacador_bloco,
    "<span style='color:#bdc3c7'>_________________________________</span><br>",
    espacador_bloco,
    "<b><span style='color:", cor_empenhado, "; font-size:", tam_centro_corpo, "px;'>EMPENHADOS: ", res_n, " (", res_p, "%)</span></b><br>",
    espacador_frase,
    "<b><span style='color:", cor_empenhado, "; font-size:", tam_centro_corpo, "px;'>Valor: R$ ", base::format(res_v, big.mark = ".", decimal.mark = ","), "</span></b><br>",
    espacador_bloco,
    "<b><span style='color:", cor_pendente, "; font-size:", tam_centro_corpo, "px;'>PENDENTES: ", pen_n, " (", pen_p, "%)</span></b><br>",
    espacador_frase,
    "<b><span style='color:", cor_pendente, "; font-size:", tam_centro_corpo, "px;'>Valor: R$ ", base::format(pen_v, big.mark = ".", decimal.mark = ","), "</span></b><br>",
    "<span style='color:#bdc3c7'>_________________________________</span><br>",
    "</span>"
  )
  
  # --- 4. CONSTRUÇÃO DO PLOTLY ---
  plotly::plot_ly(df_modalidade, labels = ~label_grafico, values = ~n_processos, type = 'pie', hole = 0.75,
                  textinfo = 'text', text = ~label_grafico, hoverinfo = 'text', hovertext = ~hover_txt,
                  marker = base::list(colors = cores_fatias, line = base::list(color = '#FFFFFF', width = 3))) %>%
    plotly::layout(
      title = base::list(text = "<b>Análise de Gestão: Consolidado Setorial</b>", 
                         font = base::list(family = fonte_padrao, size = tam_titulo_graf, color = cor_titulo)),
      font = base::list(family = fonte_padrao, size = tam_fatias),
      showlegend = FALSE,
      hoverlabel = base::list(bgcolor = "white", bordercolor = "black", align = "left", 
                              font = base::list(family = fonte_padrao, color = "black")),
      annotations = base::list(text = texto_centro, showarrow = FALSE)
    )
}


gerar_dashboard_setor(
  bd_principal, 
  
  # --- Configurações do Centro (Gráfico) ---
  tam_titulo_graf  = 0,        # Título principal bem grande
  tam_centro_cab   = 10,        # Cabeçalho "SUMÁRIO CONSOLIDADO"
  tam_centro_dest  = 10,        # Processos, Valor e Eficiência Global
  tam_centro_corpo = 10,        # Blocos de Empenhados e Pendentes
  
  # --- Configurações do Hover (Balão ao passar o mouse) ---
  tam_hover_header = 10,        # Título da Modalidade no balão (Destaque)
  tam_hover_dest   = 10,        # Eficiência dentro do balão
  tam_hover_corpo  = 10,        # Informações detalhadas do balão
  
  # --- Rótulos e Cores Técnicas ---
  tam_fatias       = 10,        # Nomes das modalidades nas fatias do gráfico
  cor_eficiencia   = "#000080", # Azul Marinho para a Eficiência
  cor_titulo       = "#000000"  # Preto absoluto para o título
)
```

## Daniel

```{r}
#| label: Daniel
#| code-summary: "Daniel"
#| echo: false
#| warning: false
#| message: false
#| out-width: "100%"
#| fig-height: 7
# ==========================================================
# FUNÇÃO MESTRE PARA DASHBOARD (VERSÃO FINAL GOLD)
# ==========================================================
gerar_dashboard_agente <- function(agente_alvo, bd_principal) {
  
  # --- BLOCO DE CONFIGURAÇÃO (ESTILO RIGOROSO) ---
  fonte_padrao     <- "Inter, sans-serif"
  cores_fatias     <- c('#74c69d', '#40916c', '#6fffe9', '#5bc0be', '#3a506b', '#1c2541', '#0b132b', '#081c15', '#000000')
  
  cor_titulo       <- "#081c15" 
  cor_empenhado    <- "#008000"
  cor_pendente     <- "#B22222"
  cor_eficiencia   <- "#0b132b" 
  
  tam_titulo       <- 20
  tam_corpo_centro <- 13 
  tam_destaque     <- 16 
  
  espacador_frase  <- "<span style='font-size:4px;'><br></span>"
  espacador_bloco  <- "<span style='font-size:10px;'><br></span>"
  
  # --- TRAVA DE SEGURANÇA ---
  df_filtro <- bd_principal %>% dplyr::filter(agente == agente_alvo)
  if (base::nrow(df_filtro) == 0) {
    base::message(base::paste0("⚠ Agente '", agente_alvo, "' sem dados. Pulando..."))
    return(NULL)
  }
  
  # --- 1. PROCESSAMENTO ---
  df_proc_unico <- df_filtro %>%
    dplyr::group_by(processo) %>%
    dplyr::summarise(
      modalidade       = dplyr::first(modalidade_processo),
      tempo_processo   = base::max(dias_uteis, na.rm = TRUE),
      valor_processo   = base::sum(valor_total, na.rm = TRUE),
      total_itens_proc = dplyr::n(),
      itens_empenhados = base::sum(status_item == "Empenhado" | !base::is.na(nota_de_empenho), na.rm = TRUE),
      valor_empenhado  = base::sum(base::ifelse(status_item == "Empenhado" | !base::is.na(nota_de_empenho), valor_total, 0), na.rm = TRUE),
      .groups = "drop"
    ) %>%
    dplyr::mutate(situacao_proc = base::ifelse(itens_empenhados == total_itens_proc, "Resolvido", "Pendente"))
  
  # --- 2. AGRUPAMENTO POR MODALIDADE (RÓTULOS E HOVER) ---
  df_modalidade <- df_proc_unico %>%
    dplyr::group_by(modalidade) %>%
    dplyr::summarise(
      n_processos = dplyr::n(), n_resolvidos = base::sum(situacao_proc == "Resolvido"),
      n_pendentes = base::sum(situacao_proc == "Pendente"), valor_total_mod = base::sum(valor_processo),
      valor_emp_mod = base::sum(valor_empenhado), tempo_medio_mod = base::mean(tempo_processo, na.rm = TRUE), .groups = "drop"
    ) %>%
    dplyr::mutate(
      p_res = base::sprintf("%.2f", (n_resolvidos / n_processos) * 100),
      p_pen = base::sprintf("%.2f", (n_pendentes / n_processos) * 100),
      v_total_txt = base::paste0("R$ ", base::format(valor_total_mod, big.mark = ".", decimal.mark = ",")),
      v_emp_txt = base::paste0("R$ ", base::format(valor_emp_mod, big.mark = ".", decimal.mark = ",")),
      v_pen_txt = base::paste0("R$ ", base::format(valor_total_mod - valor_emp_mod, big.mark = ".", decimal.mark = ",")),
      
      # TEXTO QUE APARECE NAS FATIAS (Label + N + %)
      label_grafico = base::paste0(modalidade, "<br>", n_processos, " proc. (", 
                                   base::sprintf("%.1f", (n_processos / base::sum(n_processos)) * 100), "%)"),
      
      hover_txt = base::paste0("<span style='color:black; font-family:", fonte_padrao, "'>",
                               "<b>MODALIDADE: ", modalidade, "</b><br>",
                               "<span style='color:#bdc3c7'>──────────────────────────</span><br>",
                               "<b>PERFORMANCE E FLUXO</b><br>",
                               "<span style='color:", cor_eficiencia, "; font-size:14px;'>📊 <b>Eficiência: ", p_res, "%</b></span><br>",
                               "⏱ <b>Ciclo Médio:</b> ", base::round(tempo_medio_mod, 0), " dias úteis<br>",
                               "📦 <b>Volume:</b> ", n_processos, " processos totais<br>",
                               "<span style='color:#bdc3c7'>──────────────────────────</span><br>",
                               "<b>STATUS DOS PROCESSOS</b><br>",
                               "• Resolvidos: ", n_resolvidos, " (", p_res, "%)<br>",
                               "• Pendentes: ", n_pendentes, " (", p_pen, "%)<br>",
                               "<span style='color:#bdc3c7'>──────────────────────────</span><br>",
                               "<b>APORTE FINANCEIRO</b><br>",
                               "💰 <b>Total:</b> ", v_total_txt, "<br>",
                               "✅ <b>Empenhado:</b> ", v_emp_txt, "<br>",
                               "❌ <b>Pendente:</b> ", v_pen_txt, "</span>")
    )
  
  # --- 3. MÉTRICAS DO CENTRO ---
  total_p <- base::nrow(df_proc_unico); total_v <- base::sum(df_proc_unico$valor_processo)
  res_n <- base::sum(df_proc_unico$situacao_proc == "Resolvido"); res_v <- base::sum(df_proc_unico$valor_empenhado)
  res_p <- base::sprintf("%.2f", (res_n / total_p) * 100)
  pen_n <- total_p - res_n; pen_v <- total_v - res_v; pen_p <- base::sprintf("%.2f", (pen_n / total_p) * 100)
  eficiencia_global <- base::sprintf("%.2f", (res_n / total_p) * 100)
  
  texto_centro <- base::paste0(
    "<span style='font-family:", fonte_padrao, ";'>",
    "<b><span style='color:", cor_titulo, "; font-size:", tam_corpo_centro + 2, "px;'>SUMÁRIO CONSOLIDADO</span></b><br>",
    "<span style='color:#bdc3c7'>_________________________________</span><br>",
    espacador_bloco,
    "<b><span style='font-size:", tam_destaque, "px;'>Processos Totais: ", total_p, "</span></b><br>",
    espacador_frase,
    "<b><span style='font-size:", tam_destaque, "px;'>Valor Total: R$ ", base::format(total_v, big.mark = ".", decimal.mark = ","), "</span></b><br>",
    espacador_frase,
    "<span style='color:", cor_eficiencia, "; font-size:", tam_destaque, "px;'>📊 <b>Eficiência Global: ", eficiencia_global, "%</b></span><br>",
    espacador_bloco,
    "<span style='color:#bdc3c7'>_________________________________</span><br>",
    espacador_bloco,
    "<b><span style='color:", cor_empenhado, "; font-size:", tam_destaque, "px;'>EMPENHADOS: ", res_n, " (", res_p, "%)</span></b><br>",
    espacador_frase,
    "<b><span style='color:", cor_empenhado, "; font-size:", tam_destaque, "px;'>Valor: R$ ", base::format(res_v, big.mark = ".", decimal.mark = ","), "</span></b><br>",
    espacador_bloco,
    "<b><span style='color:", cor_pendente, "; font-size:", tam_destaque, "px;'>PENDENTES: ", pen_n, " (", pen_p, "%)</span></b><br>",
    espacador_frase,
    "<b><span style='color:", cor_pendente, "; font-size:", tam_destaque, "px;'>Valor: R$ ", base::format(pen_v, big.mark = ".", decimal.mark = ","), "</span></b><br>",
    "<span style='color:#bdc3c7'>_________________________________</span><br>",
    espacador_bloco,
    "</span>"
  )
  
  # --- 4. CONSTRUÇÃO DO GRÁFICO ---
  plotly::plot_ly(df_modalidade, labels = ~label_grafico, values = ~n_processos, type = 'pie', hole = 0.75,
                  textinfo = 'text', text = ~label_grafico, hoverinfo = 'text', 
                  hovertext = ~hover_txt, # Usando hovertext para garantir a exibição do hover_txt organizado
                  marker = base::list(colors = cores_fatias, line = base::list(color = '#FFFFFF', width = 3))) %>%
    plotly::layout(
      title = base::list(text = base::paste0("<b>Análise de Gestão: ", agente_alvo, "</b>"), 
                         font = base::list(family = fonte_padrao, size = tam_titulo, color = cor_titulo)),
      font = base::list(family = fonte_padrao),
      showlegend = FALSE,
      hoverlabel = base::list(bgcolor = "white", bordercolor = "black", align = "left", 
                              font = base::list(family = fonte_padrao, color = "black")),
      annotations = base::list(text = texto_centro, showarrow = FALSE)
    ) %>%
  # Configuração de responsividade e ocultação da barra do Plotly
  plotly::config(displayModeBar = FALSE, responsive = TRUE)
}

gerar_dashboard_agente("Daniel", bd_principal)

```




## ARP - ATA
Conteúdo da modalidade ARP - ATA

## CAE
Conteúdo da modalidade CAE

## DLE
Conteúdo da modalidade DLE

## INEX
Conteúdo da modalidade INEX

## PE
Conteúdo da modalidade PE

## RDL
Conteúdo da modalidade RDL

:::




```{r}
# ==========================================================
# 1. PRÉ-PROCESSAMENTO: STATUS POR PROCESSO
# ==========================================================
status_por_processo <- bd_principal %>%
  dplyr::group_by(processo) %>%
  dplyr::summarise(
    proc_resolvido = base::all(status_item == "Empenhado" | !base::is.na(nota_de_empenho)),
    valor_do_proc  = base::sum(valor_total, na.rm = TRUE),
    qtd_itens_proc = dplyr::n(),
    itens_res_proc = base::sum(status_item == "Empenhado" | !base::is.na(nota_de_empenho), na.rm = TRUE),
    itens_pen_proc = base::sum(status_item != "Empenhado" & base::is.na(nota_de_empenho), na.rm = TRUE),
    tempo_do_proc  = base::mean(dias_uteis, na.rm = TRUE),
    agente_proc    = dplyr::first(agente),
    mod_proc       = dplyr::first(modalidade_processo),
    .groups = "drop"
  ) %>%
  dplyr::filter(!base::is.na(mod_proc), tempo_do_proc > 0)

# ==========================================================
# 2. BANCO PAI: CONSOLIDADO POR MODALIDADE (MÉDIAS DE REFERÊNCIA)
# ==========================================================
bd_pai_modalidade <- status_por_processo %>%
  dplyr::group_by(mod_proc) %>%
  dplyr::summarise(
    n_processos      = dplyr::n(),
    v_total_mod      = base::sum(valor_do_proc, na.rm = TRUE),
    n_resolvidos     = base::sum(proc_resolvido == TRUE),
    n_pendentes      = base::sum(proc_resolvido == FALSE),
    itens_res_total  = base::sum(itens_res_proc),
    itens_pen_total  = base::sum(itens_pen_proc),
    v_resolvido      = base::sum(base::ifelse(proc_resolvido == TRUE, valor_do_proc, 0)),
    v_pendente       = base::sum(base::ifelse(proc_resolvido == FALSE, valor_do_proc, 0)),
    # Esta é a Média do Setor que será a base da comparação
    ciclo_medio_mod  = base::mean(tempo_do_proc, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  dplyr::mutate(
    p_resolvido      = (n_resolvidos / n_processos) * 100,
    p_pendente       = (n_pendentes / n_processos) * 100,
    aporte_total     = base::paste0("R$ ", base::format(v_total_mod, big.mark = ".", decimal.mark = ",")),
    aporte_resolvido = base::paste0("R$ ", base::format(v_resolvido, big.mark = ".", decimal.mark = ",")),
    aporte_pendente  = base::paste0("R$ ", base::format(v_pendente, big.mark = ".", decimal.mark = ",")),
    p_resolvido_txt  = base::paste0(base::round(p_resolvido, 1), "%"),
    p_pendente_txt   = base::paste0(base::round(p_pendente, 1), "%"),
    ciclo_txt        = base::paste0(base::round(ciclo_medio_mod, 1), " dias")
  ) %>%
  dplyr::arrange(dplyr::desc(p_resolvido))

# ==========================================================
# 3. BANCO FILHO: PERFORMANCE E COMPARAÇÃO POR AGENTE
# ==========================================================
bd_filho_agentes <- status_por_processo %>%
  dplyr::mutate(agente_proc = base::ifelse(base::is.na(agente_proc), "Não Identificado", base::as.character(agente_proc))) %>%
  dplyr::group_by(mod_proc, agente_proc) %>%
  dplyr::summarise(
    total_proc_ag   = dplyr::n(),
    res_ag          = base::sum(proc_resolvido == TRUE),
    pen_ag          = base::sum(proc_resolvido == FALSE),
    itens_ag_res    = base::sum(itens_res_proc),
    itens_ag_pen    = base::sum(itens_pen_proc),
    v_gestao_ag     = base::sum(valor_do_proc, na.rm = TRUE),
    # Média Individual do Agente nesta modalidade
    tempo_ag_num    = base::mean(tempo_do_proc, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  # Trazemos a média da modalidade para dentro do banco do agente para comparar
  dplyr::left_join(bd_pai_modalidade %>% dplyr::select(mod_proc, ciclo_medio_mod), by = "mod_proc") %>%
  dplyr::group_by(mod_proc) %>%
  dplyr::mutate(
    p_efic_ag     = (res_ag / total_proc_ag) * 100,
    rank_prod     = base::rank(base::interaction(-p_efic_ag, -total_proc_ag, tempo_ag_num), ties.method = "min"),
    
    # --- CÁLCULO DA ESCALA LIKERT ---
    # Razão entre o tempo do Daniel e a média da modalidade dele
    razao_tempo   = tempo_ag_num / ciclo_medio_mod,
    
    avaliacao_txt = dplyr::case_when(
      razao_tempo <= 0.7 ~ "Muito Superior",
      razao_tempo <= 0.9 ~ "Superior",
      razao_tempo <= 1.1 ~ "Regular",
      razao_tempo <= 1.4 ~ "Inferior",
      TRUE               ~ "Muito Inferior" # Corrigido: TRUE sem prefixo
    ),
    
    agente_rank   = base::paste0(rank_prod, "º - ", agente_proc),
    aporte_gestao = base::paste0("R$ ", base::format(v_gestao_ag, big.mark = ".", decimal.mark = ",")),
    eficiencia_ag = base::paste0(base::round(p_efic_ag, 1), "%"),
    ciclo_ag_txt  = base::paste0(base::round(tempo_ag_num, 1), " dias"),
    media_setor   = base::paste0(base::round(ciclo_medio_mod, 1), " dias")
  ) %>%
  dplyr::ungroup() %>%
  dplyr::select(mod_proc, agente_rank, total_proc_ag, res_ag, pen_ag, itens_ag_res, itens_ag_pen, aporte_gestao, ciclo_ag_txt, media_setor, avaliacao_txt, eficiencia_ag)

# ==========================================================
# 4. CONFIGURAÇÃO DE COLUNAS
# ==========================================================
nomes_col <- base::c(
  "Modalidade"               = "mod_proc",
  "Nº<br>Processos"          = "n_processos",
  "Aporte<br>Consolidado"    = "aporte_total",
  "Processos<br>Finalizados" = "n_resolvidos",
  "Aporte<br>Resolvido"         = "aporte_resolvido",
  "Eficiência (%)"           = "p_resolvido_txt",
  "Processos<br>Pendentes"   = "n_pendentes",
  "Aporte<br>Pendente"          = "aporte_pendente",
  "Ciclo<br>Médio"              = "ciclo_txt"
)

largura_col <- base::c("30px",
                       "130px", 
                       "90px", 
                       "130px",
                       "60px", 
                       "130px", 
                       "50px", 
                       "60px", 
                       "130px", 
                       "60px")

alinhamento_col <- base::c(
  "center","center","center","center","center","center","center","center","center"
)

nomes_det <- base::c(
  "Agente<br>(Rank)", 
  "Processos", 
  "Finalizados", 
  "Pendentes", 
  "Itens<br>Resolvidos", 
  "Itens<br>Pendentes", 
  "Aporte em<br>Gestão", 
  "Ciclo<br>(Agente)", 
  "Média<br>(Modalidade)", 
  "Avaliação<br>(Likert)", 
  "Eficiência<br>Individual"
)

# Ajuste nas larguras dos detalhes para acomodar a nova coluna
largura_det <- base::c("130px", 
                       "40px", 
                       "40px", 
                       "40px", 
                       "100px", 
                       "100px", 
                       "260px", 
                       "80px",
                       "100px",
                       "90px",
                       "100px")

alinhamento_det <- base::c(
  "center","center","center","center","center","center","left","center","center","center","center")

# ==========================================================
# 5. EXECUÇÃO
# ==========================================================
tabela_interativa_detalhes(
  dados                  = bd_pai_modalidade,
  dados_detalhes         = bd_filho_agentes,
  coluna_chave           = "mod_proc",
  titulo_tabela          = "Detalhamento das atividades",
  
  tam_fonte_corpo        = tam_fonte_corpo,
  tam_fonte_header       = tam_fonte_header,
  tam_fonte_titulo       = tam_fonte_titulo,
  cor_titulo             = cor_titulo,
  cor_primaria           = cor_primaria,
  cor_texto_corpo        = cor_texto_corpo,
  alinhamento_header_vetor = alinhamento_col,
  alinhamento_corpo_vetor = alinhamento_det,
  
  colunas_detalhes_nomes = nomes_det, 
  largura_detalhes_vetor = largura_det, 
  largura_cols_vetor = largura_col,  
  colunas_selecionadas = nomes_col,
  pesquisa_geral         = TRUE,
  mostrar_filtro         = FALSE,
  mostrar_indice         = FALSE,
)

```


:::


::: {style="font-size: 0.9em; text-align: justify; margin-top: 25px; margin-bottom: 25px; "}

:::


## Modalidades | Natureza da Despesa (R$)

::: {style="font-size: 0.9em; text-align: justify; margin-top: 25px; margin-bottom: 25px; "}

::: {.panel-tabset}

## AD
Conteúdo da modalidade AD  
Texto, gráfico, tabela ou código

## ARP - ATA
Conteúdo da modalidade ARP - ATA

## CAE
Conteúdo da modalidade CAE

## DLE
Conteúdo da modalidade DLE

## INEX
Conteúdo da modalidade INEX

## PE
Conteúdo da modalidade PE

## RDL
Conteúdo da modalidade RDL

:::

:::


<!-- Tabela - catalogo -->


## Catálogo E-compras e Fluxo de Itens

::: {style="font-size: 0.9em; text-align: justify; margin-top: 25px; margin-bottom: 25px; "}


```{r}
#| label: Tabela catalogo
#| code-summary: "Tabela do catálogo"
#| echo: false
#| warning: false
#| message: false


# --- 1. AJUSTE DE LARGURAS (ESTRUTURA HORIZONTAL CATÁLOGO) ---
minhas_larguras_catalogo <- base::c(
  "80px",   # ID do item
  "470px",  # Descrição do item
  "120px",  # Elemento (Material / Serviço)
  "230px",  # Grupo
  "230px",  # Subgrupo
  "230px"   # Grupo do item
)

# --- 2. SELEÇÃO E RENOMEAÇÃO (CURADORIA DE DADOS) ---
minhas_colunas_catalogo <- base::c(
  "ID"            = "id",
  "Descrição"     = "descricao",
  "Elemento"      = "elemento",
  "Grupo"         = "grupo",
  "Subgrupo"      = "subgrupo",
  "Grupo do Item" = "grupo_item"
)

# ==========================================================
# EXECUÇÃO: TABELA CATÁLOGO (Função Simples)
# ==========================================================
tabela_interativa(
  dados = bd_catalogo,
  titulo_tabela = "Catálogo E-Compras",
  
  # Configurações de visual enviadas
  tam_fonte_corpo   = tam_fonte_corpo,
  tam_fonte_titulo  = tam_fonte_titulo,
  tam_fonte_header  = tam_fonte_header,
  cor_titulo        = cor_titulo,
  cor_primaria      = cor_primaria,
  cor_texto_corpo   = cor_texto_corpo,
  
  # Controle e Layout
  mostrar_filtro    = FALSE,
  pesquisa_geral    = TRUE,
  largura_cols_vetor   = minhas_larguras_catalogo,
  colunas_selecionadas = minhas_colunas_catalogo,
  n_pages = 6,
  mostrar_indice = FALSE
)


```

:::


  
<br>

::: {style="border-top: 2px solid #003366;"}
:::

<br>

